<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | Olimpiyat Kokoreç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        .tab-button.active { background-color: #fb923c; color: white; }
        /* Sıralama Modülü İçin Stiller */
        .sortable-item { cursor: grab; }
        .sortable-item:active { cursor: grabbing; }
        .sortable-ghost {
            opacity: 0.4;
            background: #ffe6cc; 
            border: 2px dashed #fb923c;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <div class="w-64 bg-orange-600 text-white flex flex-col p-4 shadow-xl">
            <h1 class="text-3xl font-bold mb-8 border-b border-orange-400 pb-2">Admin Panel</h1>
            <button id="showProducts" class="tab-button active text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                📦 Ürün Yönetimi
            </button>
            <button id="showSorting" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ⬆️ Ürün Sıralama Ayarı
            </button>
            <button id="showAddProduct" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ➕ Yeni Ürün Ekle
            </button>
            <button id="showBulkUpdate" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                💸 Toplu Fiyat Değiştirme
            </button>
            <button id="showStats" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                📊 İstatistikler
            </button>
            <a href="index.html" class="mt-auto p-3 bg-red-500 text-center rounded hover:bg-red-600 transition">
                Çıkış Yap
            </a>
        </div>

        <main class="flex-1 p-8 overflow-y-auto">
            <div id="contentContainer">
                </div>
        </main>
    </div>

    <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-[500px] relative max-h-[90vh] overflow-y-auto">
            <button id="closeEditProductModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">✖</button>
            <h2 class="text-xl font-bold mb-3 text-orange-600">Ürün Düzenle</h2>
            
            <input type="hidden" id="editProductKey" />
            
            <div class="flex flex-col gap-3">
                <div class="p-3 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold mb-2">Görsel Düzenleme</h3>
                    <img id="editImagePreview" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-300" src="" alt="Ürün Görseli Önizleme">
                    <button id="uploadEditImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition w-full">Yeni Görsel Yükle</button>
                    <input type="hidden" id="editImageURL" value="" />
                </div>

                <input id="editName" placeholder="Ürün Adı (TR)" class="border p-2 rounded" />
                <input id="editNameEN" placeholder="Product Name (EN)" class="border p-2 rounded" />
                <input id="editDesc" placeholder="Açıklama (TR)" class="border p-2 rounded" />
                <input id="editDescEN" placeholder="Description (EN)" class="border p-2 rounded" />
                <input id="editPrice" type="number" placeholder="Fiyat (₺)" class="border p-2 rounded" />
                <select id="editCategory" class="border p-2 rounded"></select>

                <button id="saveEditProduct" class="bg-green-500 text-white px-4 py-2 rounded mt-4 hover:bg-green-600 transition">Değişiklikleri Kaydet</button>
            </div>
        </div>
    </div>


    <script>
        // --- Sabitler ve Ayarlar (Kullanıcının Firebase Kodu DEĞİŞTİRİLMEDİ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcYNF0hMow-y1MuV3GXLG9vY_MK0tJTGs",
            authDomain: "olimpiyatkokorecmenu.firebaseapp.com",
            projectId: "olimpiyatkokorecmenu",
            messagingSenderId: "987017604417",
            appId: "1:987017604417:web:b6c4858712dc66d14745c0",
            measurementId: "G-HB0J7BFZ9N",
            databaseURL: "https://olimpiyatkokorecmenu-default-rtdb.europe-west1.firebasedatabase.app" 
        };
        const CLOUDINARY_CLOUD_NAME = 'dtkrwqofx';      
        const CLOUDINARY_UPLOAD_PRESET = 'olimpiyat_menu'; 

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const productsRef = database.ref('products');
        const visitorsRef = database.ref('visitors');
        
        // Ürün listesini tutar. Sıralama için 'order' alanı kullanılacak.
        let products = []; 
        const categoriesTR = ['Menüler', 'Kokoreç', 'Tavuk Kokoreç', 'Tavuk Döner', 'Patso', 'Köfte', 'Ciğer', 'Hamburger', 'Tost', 'Midye', 'Yan Lezzetler', 'İçecekler']; 
        
        // --- HTML Element Tanımlamaları ---
        const contentContainer = document.getElementById('contentContainer');
        const showProductsBtn = document.getElementById('showProducts');
        const showSortingBtn = document.getElementById('showSorting'); // YENİ BUTON
        const showAddProductBtn = document.getElementById('showAddProduct');
        const showBulkUpdateBtn = document.getElementById('showBulkUpdate');
        const showStatsBtn = document.getElementById('showStats');
        const tabButtons = document.querySelectorAll('.tab-button');
        const editProductModal = document.getElementById('editProductModal');
        const closeEditProductModal = document.getElementById('closeEditProductModal');
        const editImageURLInput = document.getElementById('editImageURL');
        const editImagePreview = document.getElementById('editImagePreview');
        const uploadEditImageBtn = document.getElementById('uploadEditImageBtn');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        
        // --- MODÜL VE UI YÖNETİMİ ---

        function setActiveTab(buttonId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(buttonId).classList.add('active');
        }

        function loadModule(htmlContent) {
            contentContainer.innerHTML = htmlContent;
        }

        // --- CLOUDINARY WIDGET FONKSİYONU ---
        function openCloudinaryWidget(urlInput, previewImg) {
            if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                alert("Hata: Cloudinary ayarları eksik.");
                return;
            }

            const widget = window.cloudinary.createUploadWidget(
                {
                    cloudName: CLOUDINARY_CLOUD_NAME,
                    uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                    sources: ['local', 'url', 'camera'], 
                },
                (error, result) => {
                    if (!error && result && result.event === "success") {
                        const url = result.info.secure_url;
                        urlInput.value = url; 
                        previewImg.src = url; 
                        previewImg.classList.remove('hidden'); 
                        alert("Görsel yüklendi ve URL kaydedildi.");
                    } else if (error) {
                        console.error("Cloudinary yükleme hatası:", error);
                        alert("Görsel yüklenirken bir hata oluştu: " + error.message);
                    }
                }
            );
            widget.open();
        }

        // --- FIREBASE CRUD & GÜNCELLEME İŞLEVLERİ ---
        
        // Ürün ekleme/güncelleme sırasında lastUpdated alanı otomatik güncellenir
        async function updateProductInFirebase(key, updates) {
            updates.lastUpdated = Date.now(); // Fiyat değişim tarihini kaydet
            await productsRef.child(key).update(updates);
        }

        async function deleteProductFromFirebase(key) {
            await productsRef.child(key).remove();
        }

        // Ürünleri 'order' alanına göre sıralayan yardımcı fonksiyon
        function sortProductsByOrder(productsArray) {
            // 'order' alanı olmayan ürünleri listenin en sonuna atar (9999)
            return productsArray.sort((a, b) => (a.order === undefined ? 9999 : a.order) - (b.order === undefined ? 9999 : b.order));
        }


        // --- MODÜL: ÜRÜN YÖNETİMİ (PRODUCTS) ---
        function renderProductsModule() {
            setActiveTab('showProducts');
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">📦 Ürün Yönetimi</h2>
                <div class="flex gap-4 mb-4">
                    <select id="filterCategory" class="border p-2 rounded flex-1">
                        <option value="Tümü">Tümü</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <ul id="productList" class="flex flex-col gap-3">
                    <li class="p-4 bg-white rounded shadow text-gray-500">Ürünler yükleniyor...</li>
                </ul>
            `);
            // Event Listener'ları Modül yüklendikten sonra eklenir
            const filterSelect = document.getElementById('filterCategory');
            filterSelect.addEventListener('change', () => renderProductList(filterSelect.value));
            renderProductList(filterSelect.value);
        }

        function renderProductList(filter='Tümü') {
            const listEl = document.getElementById('productList');
            if (!listEl) return;
            listEl.innerHTML = '';
            
            // Sıralama yap: Mevcut ürün listesini order'a göre sırala
            const sortedProducts = sortProductsByOrder([...products]); // products'ı kopyalayıp sırala
            
            const filtered = filter === 'Tümü' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                listEl.innerHTML = '<li class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride ürün bulunmamaktadır.</li>';
                return;
            }

            filtered.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'flex justify-between items-center bg-white p-3 rounded border shadow-sm';
                item.innerHTML = `
                    <span class="font-medium text-base">${p.name} (${p.category}) - ${p.price} ₺</span>
                    <div>
                        <button data-key="${p.key}" class="editBtn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition mr-2">Düzenle</button>
                        <button data-key="${p.key}" class="deleteBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            // Delete Event
            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const productKeyToDelete = e.target.dataset.key;
                    if (confirm("Bu ürünü silmek istediğinizden emin misiniz?")) {
                        try { await deleteProductFromFirebase(productKeyToDelete); alert("Ürün silindi."); } 
                        catch (error) { alert("Silme işlemi başarısız oldu: " + error.message); }
                    }
                });
            });
            // Edit Event
            document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', (e) => openEditModal(e.target.dataset.key)));
        }
        
        // --- YENİ MODÜL: ÜRÜN SIRALAMA AYARI (SORTING) ---
        
        function renderSortingModule() {
            // Sortable.js kütüphanesinin yüklenip yüklenmediğini kontrol et
            if (typeof Sortable === 'undefined') {
                alert("Hata: Ürün sıralama özelliği için gerekli kütüphane (Sortable.js) yüklenemedi. İnternet bağlantınızı kontrol edin.");
                return;
            }
            
            setActiveTab('showSorting');
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">⬆️ Ürün Sıralama Ayarı</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">Ürünleri sürükleyip bırakarak menüdeki sıralamasını değiştirebilirsiniz. Bu ayar tüm dillerde geçerli olacaktır.</p>
                    
                    <label class="block mb-2 font-semibold text-sm">Sıralanacak Kategori Seçin:</label>
                    <select id="sortCategory" class="border p-2 rounded w-full mb-6">
                        <option value="">-- Kategori Seçiniz --</option>
                        <option value="Tümü">Tümü (Tüm Ürünler)</option> ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <ul id="sortableList" class="flex flex-col gap-2 p-2 border rounded bg-gray-50 min-h-[100px]">
                        <li class="text-gray-500 text-center py-4">Lütfen yukarıdan bir kategori seçiniz.</li>
                    </ul>
                    
                    <button id="saveSorting" class="mt-6 bg-green-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-green-600 transition w-full hidden">Yeni Sıralamayı Kaydet</button>
                    <p id="sortingStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);
            
            // Event Listeners
            const sortCategorySelect = document.getElementById('sortCategory');
            sortCategorySelect.addEventListener('change', (e) => loadSortableList(e.target.value));
            document.getElementById('saveSorting').addEventListener('click', saveSortingOrder);
        }
        
        // Kategori seçildiğinde sürükle-bırak listesini yükler
        function loadSortableList(category) {
            const listEl = document.getElementById('sortableList');
            const saveBtn = document.getElementById('saveSorting');
            const statusEl = document.getElementById('sortingStatus');
            statusEl.classList.add('hidden');
            saveBtn.classList.add('hidden');
            listEl.innerHTML = '';
            
            if (!category) {
                listEl.innerHTML = '<li class="text-gray-500 text-center py-4">Lütfen yukarıdan bir kategori seçiniz.</li>';
                return;
            }
            
            // Seçili kategoriye göre filtrele ve mevcut 'order' alanına göre sırala
            const filteredProducts = category === 'Tümü'
                ? products
                : products.filter(p => p.category === category);
            
            const filteredAndSorted = sortProductsByOrder(filteredProducts);


            if (filteredAndSorted.length === 0) {
                listEl.innerHTML = `<li class="text-gray-500 text-center py-4">"${category}" kategorisinde ürün bulunmamaktadır.</li>`;
                return;
            }
            
            filteredAndSorted.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'sortable-item flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-200';
                // data-id ile Firebase Key'i sakla
                item.dataset.id = p.key; 
                item.innerHTML = `
                    <span class="text-gray-400 mr-3">☰</span>
                    <span class="font-medium text-base flex-1">${p.name}</span>
                    <span class="text-orange-600 font-semibold">${p.price} ₺</span>
                `;
                listEl.appendChild(item);
            });
            
            saveBtn.classList.remove('hidden');

            // Sortable.js'i bu liste üzerinde etkinleştir
            Sortable.create(listEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    statusEl.textContent = 'Sıralama değiştirildi. Kaydet butonuna basmayı unutmayın!';
                    statusEl.classList.remove('hidden');
                    statusEl.classList.remove('text-green-600');
                    statusEl.classList.add('text-red-600');
                },
            });
        }
        
        // Yeni sıralama düzenini (order değerlerini) Firebase'e kaydeder
        async function saveSortingOrder() {
            const listEl = document.getElementById('sortableList');
            const items = listEl.children;
            const updates = {};
            const statusEl = document.getElementById('sortingStatus');
            let changesMade = 0;
            
            if (items.length === 0) return;
            
            for (let i = 0; i < items.length; i++) {
                const productKey = items[i].dataset.id;
                const newOrderValue = i; // 0'dan başlayarak index değerini yeni sıra olarak kullan
                
                const currentProduct = products.find(p => p.key === productKey);
                
                // Sadece sırası değişenleri kaydet
                if (currentProduct && currentProduct.order !== newOrderValue) {
                    // Firebase'in root (kök) referansına relative path ile yazıyoruz
                    updates[`products/${productKey}/order`] = newOrderValue; 
                    changesMade++;
                }
            }
            
            if (changesMade === 0) {
                 statusEl.textContent = 'Herhangi bir sıralama değişikliği tespit edilmedi.';
                 statusEl.classList.remove('text-red-600');
                 statusEl.classList.add('text-green-600');
                 statusEl.classList.remove('hidden');
                 return;
            }
            
            if (!confirm(`${changesMade} ürünün sıralaması güncellenecektir. Onaylıyor musunuz?`)) {
                return;
            }

            try {
                // Firebase'e toplu güncelleme (multi-path update) gönder
                await database.ref().update(updates); 
                
                statusEl.textContent = `${changesMade} ürün sıralaması başarıyla kaydedildi.`;
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                statusEl.classList.remove('hidden');
                
                // Listeyi yeniden yükle (Firebase dinleyicisi de bunu yapacak)
                const currentCategory = document.getElementById('sortCategory').value;
                loadSortableList(currentCategory); 

            } catch (error) {
                statusEl.textContent = 'Sıralamayı kaydetme başarısız oldu: ' + error.message;
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.remove('hidden');
            }
        }


        // --- MODÜL: YENİ ÜRÜN EKLEME (ADD PRODUCT) ---
        function renderAddProductModule() {
            setActiveTab('showAddProduct');
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">➕ Yeni Ürün Ekle</h2>
                <div class="flex flex-col gap-4 p-6 border rounded-lg bg-white shadow-md max-w-lg">
                    <input id="productName" placeholder="Ürün Adı (TR)" class="border p-3 rounded" />
                    <input id="productNameEN" placeholder="Product Name (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productDesc" placeholder="Açıklama (TR)" class="border p-3 rounded" />
                    <input id="productDescEN" placeholder="Description (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productPrice" type="number" placeholder="Fiyat (₺)" class="border p-3 rounded" />
                    <select id="productCategory" class="border p-3 rounded">
                        <option value="">-- Kategori Seçiniz --</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold mb-2">Görsel Yükle (Opsiyonel)</h3>
                        <button id="uploadNewImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full">Görsel Yükle</button>
                        <img id="newImagePreview" class="w-full h-32 object-cover rounded-lg mt-3 border border-gray-300" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>Görsel Yok</text></svg>" alt="Yeni Görsel Önizleme">
                        <input type="hidden" id="productImageURL" value="" />
                    </div>
                    
                    <button id="addProduct" class="bg-orange-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-orange-600 transition">Ürünü Kaydet</button>
                </div>
            `);
            // Event Listener'lar
            document.getElementById('uploadNewImageBtn').addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(document.getElementById('productImageURL'), document.getElementById('newImagePreview'));
            });
            document.getElementById('addProduct').addEventListener('click', addProduct);

            // Modül yüklendiğinde varsayılan görseli ayarla
            document.getElementById('newImagePreview').src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>Görsel Yok</text></svg>";
        }

        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const nameEN = document.getElementById('productNameEN').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const descEN = document.getElementById('productDescEN').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            
            let imageURL = document.getElementById('productImageURL').value.trim(); 
            
            if (!imageURL) { imageURL = ''; }

            if (!name || isNaN(price) || !category) { 
                alert('Lütfen tüm zorunlu alanları (Ad, Fiyat ve Kategori) doldurunuz.'); return; 
            }
            
            // Yeni ürüne, tüm ürünlerin en sonuna atılmasını sağlamak için büyük bir sıra numarası verilir.
            const maxOrder = products.length > 0 
                ? Math.max(...products.map(p => p.order === undefined ? 0 : p.order)) // undefined olanları 0 kabul et
                : 0;
            
            const newProduct = {
                name, nameEN: nameEN || name, desc, descEN: descEN || desc,
                price, image: imageURL, category, 
                lastUpdated: Date.now(),
                order: maxOrder + 1 // Yeni ürünü listenin sonuna ekle
            };

            try {
                await database.ref('products').push(newProduct); 
                alert(`"${name}" ürünü başarıyla eklendi.`);
                
                // Formu temizle
                document.querySelectorAll('#contentContainer input, #contentContainer select').forEach(el => el.value = '');
                document.getElementById('productImageURL').value = ''; 
                
                const previewImg = document.getElementById('newImagePreview');
                previewImg.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>Görsel Yok</text></svg>";
                
            } catch (error) {
                alert("Ekleme işlemi başarısız oldu: " + error.message);
            }
        }

        // --- MODÜL: TOPLU FİYAT DEĞİŞTİRME (BULK UPDATE) ---
        function renderBulkUpdateModule() {
            setActiveTab('showBulkUpdate');
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">💸 Toplu Fiyat Değiştirme</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">Aşağıdaki listede ürünlerin mevcut fiyatlarını değiştirebilir veya Toplu Değişim araçlarını kullanabilirsiniz.</p>
                    
                    <div class="border p-4 mb-6 rounded-lg bg-gray-50">
                        <h3 class="font-bold mb-3 text-orange-600">Toplu Değişim Araçları</h3>
                        <label class="block mb-2 font-semibold text-sm">Uygulanacak Kategori:</label>
                        <select id="bulkCategory" class="border p-2 rounded w-full mb-3">
                            <option value="Tümü">Tüm Ürünler</option>
                            ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>

                        <label class="block mb-2 font-semibold text-sm">Değişim Tipi:</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center"><input type="radio" name="updateType" value="percent" checked class="mr-2"> Yüzdesel (%)</label>
                            <label class="flex items-center"><input type="radio" name="updateType" value="fixed" class="mr-2"> Sabit Değer (₺)</label>
                        </div>

                        <input id="updateValue" type="number" placeholder="Örn: 10 (₺10 artış) veya -5 (%5 indirim)" class="border p-2 rounded w-full mb-4" />
                        
                        <button id="applyBulkAdjustment" class="bg-blue-500 text-white px-4 py-2 rounded font-semibold hover:bg-blue-600 transition w-full">Seçili Ürünlere Toplu Ayar Uygula</button>
                    </div>

                    <h3 class="font-bold text-xl mb-3 text-gray-800">Ürün Fiyatlarını Manuel Düzenle</h3>
                    <div class="flex font-bold text-sm bg-gray-100 p-2 rounded mb-2">
                        <span class="w-1/2">Ürün Adı</span>
                        <span class="w-1/4 text-right">Mevcut Fiyat</span>
                        <span class="w-1/4 text-right">Yeni Fiyat (₺)</span>
                    </div>
                    <form id="bulkUpdateForm" class="flex flex-col gap-2">
                        <p class="text-gray-500">Ürünler yükleniyor...</p>
                        </form>
                    
                    <button id="saveManualPrices" class="mt-6 bg-red-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-red-600 transition w-full">Girdiğim Yeni Fiyatları Kaydet</button>
                    <p id="bulkStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);

            // Event Listener'lar
            document.getElementById('bulkCategory').addEventListener('change', () => renderBulkPriceList(document.getElementById('bulkCategory').value));
            document.getElementById('applyBulkAdjustment').addEventListener('click', applyBulkAdjustment);
            document.getElementById('saveManualPrices').addEventListener('click', saveManualPrices);
            
            // İlk yüklemede listeyi göster
            renderBulkPriceList(document.getElementById('bulkCategory').value);
        }
        
        // Toplu fiyat listesini düzenlenebilir inputlarla render eder
        function renderBulkPriceList(filter='Tümü') {
            const formEl = document.getElementById('bulkUpdateForm');
            if (!formEl) return;
            formEl.innerHTML = '';
            
            // Ürünleri 'order' alanına göre sırala
            const sortedProducts = sortProductsByOrder([...products]);

            const filtered = filter === 'Tümü' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                formEl.innerHTML = '<p class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride ürün bulunmamaktadır.</p>';
                return;
            }

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-white p-2 rounded border text-sm';
                item.innerHTML = `
                    <span class="w-1/2">${p.name}</span>
                    <span class="w-1/4 text-right">${p.price} ₺</span>
                    <input 
                        type="number" 
                        step="1" 
                        placeholder="${p.price}" 
                        value="${p.price}"
                        data-key="${p.key}" 
                        class="bulk-price-input w-1/4 text-right border p-1 rounded focus:border-orange-500"
                    />
                `;
                formEl.appendChild(item);
            });
        }

        // Toplu yüzdesel/sabit ayarı input alanlarına uygular
        function applyBulkAdjustment() {
            const updateType = document.querySelector('input[name="updateType"]:checked').value;
            const value = parseFloat(document.getElementById('updateValue').value);
            const statusEl = document.getElementById('bulkStatus');
            statusEl.classList.add('hidden');

            if (isNaN(value) || value === 0) {
                statusEl.textContent = 'Lütfen geçerli bir değişim değeri girin.';
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            let updatedCount = 0;

            inputs.forEach(input => {
                const productKey = input.dataset.key;
                const currentProduct = products.find(p => p.key === productKey);
                if (!currentProduct) return;

                let newPrice;
                const basePrice = currentProduct.price; // Mevcut Firebase fiyatını kullan

                if (updateType === 'percent') {
                    newPrice = basePrice * (1 + (value / 100));
                } else { // fixed
                    newPrice = basePrice + value;
                }
                newPrice = Math.max(0, parseFloat(newPrice.toFixed(2)));
                
                // Yeni fiyatı input alanına yaz
                input.value = newPrice;
                updatedCount++;
            });

            if (updatedCount > 0) {
                statusEl.textContent = `${updatedCount} ürünün fiyatı güncellendi. Lütfen "Kaydet" butonuna basarak değişiklikleri veritabanına işleyin.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
            } else {
                 statusEl.textContent = 'Güncellenecek ürün bulunamadı.';
                 statusEl.classList.remove('hidden');
                 statusEl.classList.remove('text-green-600');
                 statusEl.classList.add('text-red-600');
            }
        }


        // Manuel girilen fiyatları Firebase'e kaydeder
        async function saveManualPrices() {
            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            const updates = {};
            const currentTime = Date.now();
            const statusEl = document.getElementById('bulkStatus');
            let changesMade = 0;

            if (inputs.length === 0) {
                statusEl.textContent = 'Kaydedilecek ürün bulunamadı.';
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            inputs.forEach(input => {
                const productKey = input.dataset.key;
                const newPrice = parseFloat(input.value);
                const currentProduct = products.find(p => p.key === productKey);

                if (isNaN(newPrice) || newPrice < 0) {
                    alert(`${currentProduct.name} ürünü için geçersiz fiyat girdiniz. Lütfen kontrol edin.`);
                    return; // İlerlemeyi durdur
                }
                
                // Sadece fiyatı değişenleri güncelle
                if (currentProduct && currentProduct.price !== newPrice) {
                    // Toplu güncelleme için path belirleme
                    updates[`products/${productKey}/price`] = newPrice;
                    updates[`products/${productKey}/lastUpdated`] = currentTime; // Güncel fiyat değişim tarihi
                    changesMade++;
                }
            });

            if (changesMade === 0) {
                statusEl.textContent = 'Herhangi bir fiyat değişikliği tespit edilmedi.';
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                return;
            }
            
            if (!confirm(`${changesMade} ürünün fiyatı güncellenecektir. Onaylıyor musunuz?`)) {
                return;
            }

            try {
                // Firebase'e toplu güncelleme (multi-path update) gönder
                await database.ref().update(updates); // Kök referanstan güncelleme yapıyoruz
                statusEl.textContent = `${changesMade} ürün fiyatı başarıyla kaydedildi ve ana menü güncellendi.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                // Listeyi yeniden render et (Firebase dinleyicisi de bunu yapmalı, ancak emin olmak için)
                renderBulkPriceList(document.getElementById('bulkCategory').value);
            } catch (error) {
                statusEl.textContent = 'Fiyatları kaydetme başarısız oldu: ' + error.message;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
            }
        }
        
        // --- MODÜL: İSTATİSTİKLER (STATS) ---
        function renderStatsModule() {
            setActiveTab('showStats');
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">📊 İstatistikler</h2>
                <div class="grid grid-cols-2 gap-6 max-w-xl">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">Bugünkü Görüntüleme</h3>
                        <p id="todayCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">Toplam Görüntüleme</h3>
                        <p id="totalCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="resetCounter" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Sayaçları Sıfırla (Manuel)</button>
                    <p class="text-sm text-gray-500 mt-2">NOT: Günlük sayaç Firebase'de gün bazında tutulur. Bu buton tüm sayaç geçmişini siler.</p>
                </div>
            `);
            fetchVisitorCounts();
            document.getElementById('resetCounter').addEventListener('click', resetVisitorCounts);
        }

        function fetchVisitorCounts() {
            const today = new Date().toISOString().slice(0, 10);
            
            // Bugünkü sayacı getir
            visitorsRef.child(today).once('value', snapshot => {
                document.getElementById('todayCount').textContent = snapshot.val() || 0;
            });

            // Toplam sayacı getir
            visitorsRef.once('value', snapshot => {
                let total = 0;
                snapshot.forEach(child => {
                    total += child.val();
                });
                document.getElementById('totalCount').textContent = total;
            });
        }
        
        async function resetVisitorCounts() {
            if (confirm("Tüm ziyaretçi verilerini sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
                try {
                    await visitorsRef.remove();
                    alert("Ziyaretçi sayaçları başarıyla sıfırlandı.");
                    fetchVisitorCounts(); // UI'ı güncelle
                } catch (error) {
                    alert("Sayaç sıfırlama başarısız oldu: " + error.message);
                }
            }
        }

        // --- EDİT MODAL ORTAK KULLANIM FONKSİYONLARI ---
        function openEditModal(productKey) {
            const productToEdit = products.find(p => p.key === productKey);
            
            if (productToEdit) {
                document.getElementById('editProductKey').value = productKey; 
                document.getElementById('editName').value = productToEdit.name;
                document.getElementById('editNameEN').value = productToEdit.nameEN || '';
                document.getElementById('editDesc').value = productToEdit.desc || '';
                document.getElementById('editDescEN').value = productToEdit.descEN || '';
                document.getElementById('editPrice').value = productToEdit.price;
                
                const editCategorySelect = document.getElementById('editCategory');
                editCategorySelect.innerHTML = categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                editCategorySelect.value = productToEdit.category;
                
                editImageURLInput.value = productToEdit.image;
                editImagePreview.src = productToEdit.image;
                
                editProductModal.classList.remove('hidden');
            }
        }

        // --- GENEL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase Dinleyicisi
            productsRef.on('value', (snapshot) => {
                products = [];
                snapshot.forEach(childSnapshot => {
                    const product = childSnapshot.val();
                    product.key = childSnapshot.key;
                    // Eğer 'order' alanı yoksa, menüde en sona atılması için bir değer atarız (render sırasında sıralanacak)
                    // Ancak Firebase'e yazarken varsayılan bir değer atamayız, sadece okurken işleriz.
                    // Ürün eklenirken zaten order alıyor.
                    products.push(product);
                });
                
                // Admin paneli açılırken varsayılan modülü yükle
                if (contentContainer.innerHTML === '') {
                   renderProductsModule(); 
                } 
                
                // Eğer ilgili modüller açıksa, listeleri yenile
                if (document.getElementById('bulkUpdateForm')) {
                    renderBulkPriceList(document.getElementById('bulkCategory').value);
                } else if (document.getElementById('productList')) {
                     renderProductList(document.getElementById('filterCategory').value);
                } else if (document.getElementById('sortableList') && document.getElementById('sortCategory').value) {
                    // Sıralama modülündeyken, listenin güncel sıralama ile yeniden yüklenmesi için
                    loadSortableList(document.getElementById('sortCategory').value);
                }
            });

            // Navigasyon Butonları
            showProductsBtn.addEventListener('click', renderProductsModule);
            showSortingBtn.addEventListener('click', renderSortingModule); // YENİ: Sıralama
            showAddProductBtn.addEventListener('click', renderAddProductModule);
            showBulkUpdateBtn.addEventListener('click', renderBulkUpdateModule);
            showStatsBtn.addEventListener('click', renderStatsModule);
            
            // Edit Modal Butonları
            closeEditProductModal.addEventListener('click', () => editProductModal.classList.add('hidden'));
            uploadEditImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(editImageURLInput, editImagePreview);
            });
            saveEditProductButton.addEventListener('click', async () => {
                const productKey = document.getElementById('editProductKey').value;
                const updates = {
                    name: document.getElementById('editName').value.trim(),
                    nameEN: document.getElementById('editNameEN').value.trim(),
                    desc: document.getElementById('editDesc').value.trim(),
                    descEN: document.getElementById('editDescEN').value.trim(),
                    price: parseFloat(document.getElementById('editPrice').value),
                    category: document.getElementById('editCategory').value,
                    image: editImageURLInput.value.trim()
                };
                
                if (isNaN(updates.price)) { alert('Lütfen geçerli bir fiyat giriniz.'); return; }

                try {
                    if (!updates.image) updates.image = ''; 

                    await updateProductInFirebase(productKey, updates); 
                    editProductModal.classList.add('hidden');
                    alert(`"${updates.name}" ürünü başarıyla güncellendi.`);
                } catch (error) {
                    alert("Güncelleme işlemi başarısız oldu: " + error.message);
                }
            });
        });
    </script>
</body>
</html>
