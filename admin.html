<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli | Olimpiyat KokoreÃ§</title>
    
    <link rel="icon" type="image/jpeg" href="/logo.jpg"> 
    <link rel="shortcut icon" href="/logo.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        /* Aktif ana menÃ¼ butonu */
        .admin-menu-button.active { background-color: #f97316; } 
        /* Aktif sol menÃ¼ butonu */
        .tab-button.active { background-color: #fb923c; color: white; }
        /* SÄ±ralama ModÃ¼lÃ¼ Ä°Ã§in Stiller */
        .sortable-item { cursor: grab; }
        .sortable-item:active { cursor: grabbing; }
        .sortable-ghost {
            opacity: 0.4;
            background: #ffe6cc; 
            border: 2px dashed #fb923c;
        }
        /* Kampanya GÃ¶rseli Ã–nizlemeleri Ä°Ã§in Yeni Stil */
        .campaign-image-preview {
            width: 100%;
            height: 120px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            border: 1px solid #d1d5db;
        }
        /* Kampanya Listesindeki GÃ¶rseller iÃ§in */
        .campaign-item-img {
            width: 80px;
            height: 45px; 
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            margin-right: 0.75rem;
        }
        .price-box-preview-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            margin-top: 8px;
            border: 2px solid #fb923c;
            background-color: white;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <div class="w-64 bg-orange-600 text-white flex flex-col p-4 shadow-xl">
            <h1 class="text-3xl font-bold mb-4 border-b border-orange-400 pb-2">Admin Panel</h1>
            
            <div class="mb-6 border-b border-orange-400 pb-4">
                <p class="text-sm font-semibold mb-2">YÃ¶netilecek MenÃ¼:</p>
                <button id="switchToInPlace" data-menu="in_place" 
                        class="admin-menu-button active w-full text-left p-2 rounded transition mb-2">
                    ğŸ½ï¸ Yerinde MenÃ¼ (products)
                </button>
                <button id="switchToDelivery" data-menu="delivery" 
                        class="admin-menu-button w-full text-left p-2 rounded hover:bg-orange-700 transition">
                    ğŸ›µ Paket Servis MenÃ¼sÃ¼ (delivery_products)
                </button>
            </div>
            <div id="copyToDeliveryContainer" class="mb-6 border-b border-orange-400 pb-4 hidden">
                <button id="copyToDeliveryBtn" 
                        class="bg-blue-500 text-white px-3 py-2 text-xs rounded-lg hover:bg-blue-600 transition font-bold w-full">
                    Yerinde MenÃ¼ Verilerini Kopyala
                </button>
                <p class="text-[10px] text-orange-200 mt-1">Sadece Paket Servis modunda gÃ¶rÃ¼nÃ¼r.</p>
            </div>


            <button id="showProducts" class="tab-button active text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ğŸ“¦ ÃœrÃ¼n YÃ¶netimi
            </button>
            <button id="showSorting" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                â¬†ï¸ ÃœrÃ¼n SÄ±ralama AyarÄ±
            </button>
            <button id="showCampaigns" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ğŸ–¼ï¸ Kampanya GÃ¶rselleri
            </button>
            <button id="showAddProduct" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                â• Yeni ÃœrÃ¼n Ekle
            </button>
            <button id="showBulkUpdate" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ğŸ’¸ Toplu Fiyat DeÄŸiÅŸtirme
            </button>
            <button id="showStats" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ğŸ“Š Ä°statistikler
            </button>
            <a href="index.html" class="mt-auto p-3 bg-red-500 text-center rounded hover:bg-red-600 transition">
                Ã‡Ä±kÄ±ÅŸ Yap
            </a>
        </div>

        <main class="flex-1 p-8 overflow-y-auto">
            <div id="contentContainer">
                </div>
        </main>
    </div>

    <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-[500px] relative max-h-[90vh] overflow-y-auto">
            <button id="closeEditProductModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">âœ–</button>
            <h2 class="text-xl font-bold mb-3 text-orange-600">ÃœrÃ¼n DÃ¼zenle</h2>
            
            <input type="hidden" id="editProductKey" />
            
            <div class="flex flex-col gap-3">
                <div class="p-3 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold mb-2">GÃ¶rsel DÃ¼zenleme</h3>
                    <img id="editImagePreview" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-300" src="" alt="ÃœrÃ¼n GÃ¶rseli Ã–nizleme">
                    <button id="uploadEditImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition w-full">Yeni GÃ¶rsel YÃ¼kle</button>
                    <input type="hidden" id="editImageURL" value="" />
                </div>

                <input id="editName" placeholder="ÃœrÃ¼n AdÄ± (TR)" class="border p-2 rounded" />
                <input id="editNameEN" placeholder="Product Name (EN)" class="border p-2 rounded" />
                <input id="editDesc" placeholder="AÃ§Ä±klama (TR)" class="border p-2 rounded" />
                <input id="editDescEN" placeholder="Description (EN)" class="border p-2 rounded" />
                <input id="editPrice" type="number" placeholder="Fiyat (â‚º)" class="border p-2 rounded" />
                <select id="editCategory" class="border p-2 rounded"></select>

                <button id="saveEditProduct" class="bg-green-500 text-white px-4 py-2 rounded mt-4 hover:bg-green-600 transition">DeÄŸiÅŸiklikleri Kaydet</button>
            </div>
        </div>
    </div>


    <script>
        // --- Sabitler ve Ayarlar ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcYNF0hMow-y1MuV3GXLG9vY_MK0tJTGs",
            authDomain: "olimpiyatkokorecmenu.firebaseapp.com",
            projectId: "olimpiyatkokorecmenu",
            messagingSenderId: "987017604417",
            appId: "1:987017604417:web:b6c4858712dc66d14745c0",
            databaseURL: "https://olimpiyatkokorecmenu-default-rtdb.europe-west1.firebasedatabase.app" 
        };
        const CLOUDINARY_CLOUD_NAME = 'dtkrwqofx';      
        const CLOUDINARY_UPLOAD_PRESET = 'olimpiyat_menu'; 

        // Firebase'i baÅŸlat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // GENEL REFERANS YOLLARI (Sabit KalsÄ±n)
        const inPlaceProductsPath = 'products';
        const inPlaceCampaignsPath = 'campaigns';
        const inPlaceCampaignInfoPath = 'campaign_info';
        const deliveryProductsPath = 'delivery_products';
        const deliveryCampaignsPath = 'delivery_campaigns';
        const deliveryCampaignInfoPath = 'delivery_campaign_info';
        const visitorsPath = 'visitors'; // ZiyaretÃ§iler her iki menÃ¼ iÃ§in de aynÄ± yolu kullanabilir.
        
        // DINAMIK REFERANSLAR (SeÃ§ili menÃ¼ye gÃ¶re deÄŸiÅŸecekler)
        let currentMenuType = 'in_place'; // BaÅŸlangÄ±Ã§ta Yerinde MenÃ¼
        let productsRef;
        let campaignsRef; 
        let campaignInfoRef;
        let priceBoxUrlRef; 
        let visitorsRef = database.ref(visitorsPath); // ZiyaretÃ§i referansÄ± sabit kalabilir.
        
        let products = []; 
        let campaignUrls = []; 
        let campaignPriceText = ""; 
        let campaignPriceBoxUrl = ""; 
        const categoriesTR = ['MenÃ¼ler', 'KokoreÃ§', 'Tavuk KokoreÃ§', 'Tavuk DÃ¶ner', 'Patso', 'KÃ¶fte', 'CiÄŸer', 'Hamburger', 'Tost', 'Midye', 'Yan Lezzetler', 'Ä°Ã§ecekler']; 
        
        // --- HTML Element TanÄ±mlamalarÄ± ---
        const contentContainer = document.getElementById('contentContainer');
        const showProductsBtn = document.getElementById('showProducts');
        const showSortingBtn = document.getElementById('showSorting'); 
        const showCampaignsBtn = document.getElementById('showCampaigns'); 
        const showAddProductBtn = document.getElementById('showAddProduct');
        const showBulkUpdateBtn = document.getElementById('showBulkUpdate');
        const showStatsBtn = document.getElementById('showStats');
        const tabButtons = document.querySelectorAll('.tab-button');
        const adminMenuButtons = document.querySelectorAll('.admin-menu-button');
        const editProductModal = document.getElementById('editProductModal');
        const closeEditProductModal = document.getElementById('closeEditProductModal');
        const editImageURLInput = document.getElementById('editImageURL');
        const editImagePreview = document.getElementById('editImagePreview');
        const uploadEditImageBtn = document.getElementById('uploadEditImageBtn');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        
        
        // --- YENÄ°: DÄ°NAMÄ°K REFERANS YÃ–NETÄ°MÄ° ---
        function setFirebaseRefs(menuType) {
            currentMenuType = menuType;
            
            if (menuType === 'in_place') {
                productsRef = database.ref(inPlaceProductsPath);
                campaignsRef = database.ref(inPlaceCampaignsPath);
                campaignInfoRef = database.ref(inPlaceCampaignInfoPath);
            } else { // 'delivery'
                productsRef = database.ref(deliveryProductsPath);
                campaignsRef = database.ref(deliveryCampaignsPath);
                campaignInfoRef = database.ref(deliveryCampaignInfoPath);
            }
            priceBoxUrlRef = campaignInfoRef.child('price_box_url');

            // Mevcut dinleyicileri kaldÄ±rÄ±p yeni referanslara yeniden baÄŸlamak iÃ§in
            // BurasÄ± kritik bir optimizasyon gerektirir, ancak basitÃ§e yeniden yÃ¼kleme ile halledelim.
            // SayfayÄ± yeniden yÃ¼klemek yerine, dinleyicileri kaldÄ±ran ve yeni referanslara baÄŸlayan bir fonksiyon yazÄ±labilir.
            // Åimdilik sadece referanslarÄ± ayarlayÄ±p, ardÄ±ndan dataListener'Ä± Ã§aÄŸÄ±racaÄŸÄ±z.
            console.log(`Firebase referanslarÄ± ayarlandÄ±: ${menuType}`);

            // UI'Ä± gÃ¼ncelle
            updateMenuButtonState(menuType);
            
            // TÃ¼m aktif dinleyicileri durdurup yeniden baÅŸlat
            stopAllListeners();
            setupDataListeners();
            
            // Mevcut aktif modÃ¼lÃ¼ yeniden render et
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                activeTab.click(); // Aktif butonu tetikle (modÃ¼lÃ¼ yeniden yÃ¼klemek iÃ§in)
            } else {
                renderProductsModule();
            }
        }
        
        // UI MenÃ¼ Butonu Durumunu GÃ¼nceller
        function updateMenuButtonState(menuType) {
             adminMenuButtons.forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.dataset.menu === menuType) {
                     btn.classList.add('active');
                 }
             });
             // Kopyalama butonunun gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ ayarla
             const copyContainer = document.getElementById('copyToDeliveryContainer');
             if (menuType === 'delivery') {
                copyContainer.classList.remove('hidden');
             } else {
                copyContainer.classList.add('hidden');
             }
        }
        
        // --- YENÄ°: VERÄ° KOPYALAMA Ä°ÅLEVÄ° ---
        async function copyMenuDataToDelivery() {
            if (currentMenuType !== 'delivery') return; // Sadece paket serviste aktif

            if (!confirm("TÃ¼m Yerinde MenÃ¼ (products) verileri, Paket Servis MenÃ¼sÃ¼ne (delivery_products) kopyalanacak. Devam etmek istiyor musunuz? Paket Servis menÃ¼sÃ¼ndeki mevcut verilerin ÃœZERÄ°NE YAZILACAKTIR!")) {
                return;
            }

            const sourceProductsRef = database.ref(inPlaceProductsPath);
            const sourceCampaignsRef = database.ref(inPlaceCampaignsPath);
            const sourceCampaignInfoRef = database.ref(inPlaceCampaignInfoPath);
            
            const targetProductsRef = database.ref(deliveryProductsPath);
            const targetCampaignsRef = database.ref(deliveryCampaignsPath);
            const targetCampaignInfoRef = database.ref(deliveryCampaignInfoPath);


            try {
                // 1. ÃœrÃ¼nleri Kopyala
                let snapshot = await sourceProductsRef.once('value');
                await targetProductsRef.set(snapshot.val() || {});
                console.log("ÃœrÃ¼nler baÅŸarÄ±yla kopyalandÄ±.");

                // 2. KampanyalarÄ± Kopyala
                snapshot = await sourceCampaignsRef.once('value');
                await targetCampaignsRef.set(snapshot.val() || {});
                console.log("Kampanyalar baÅŸarÄ±yla kopyalandÄ±.");
                
                // 3. Kampanya Bilgisini Kopyala (Fiyat Metni, Kutucuk GÃ¶rseli vb.)
                snapshot = await sourceCampaignInfoRef.once('value');
                await targetCampaignInfoRef.set(snapshot.val() || {});
                console.log("Kampanya bilgisi baÅŸarÄ±yla kopyalandÄ±.");

                alert("Veriler baÅŸarÄ±yla Yerinde MenÃ¼'den Paket Servis MenÃ¼sÃ¼'ne kopyalandÄ±!");
                
                // Kopyalama sonrasÄ± referanslarÄ±n tekrar tetiklenmesi iÃ§in
                setFirebaseRefs('delivery'); 

            } catch (error) {
                 alert("Veri kopyalama sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message);
                 console.error("Veri kopyalama hatasÄ±:", error);
            }
        }


        // --- MODÃœL VE UI YÃ–NETÄ°MÄ° ---

        function setActiveTab(buttonId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(buttonId).classList.add('active');
        }

        function loadModule(htmlContent) {
            contentContainer.innerHTML = htmlContent;
        }

        function openCloudinaryWidget(urlInput, previewImg, uploadPreset = CLOUDINARY_UPLOAD_PRESET) {
            if (!CLOUDINARY_CLOUD_NAME || !uploadPreset) {
                alert("Hata: Cloudinary ayarlarÄ± eksik.");
                return;
            }

            const widget = window.cloudinary.createUploadWidget(
                {
                    cloudName: CLOUDINARY_CLOUD_NAME,
                    uploadPreset: uploadPreset, 
                    sources: ['local', 'url', 'camera'], 
                },
                (error, result) => {
                    if (!error && result && result.event === "success") {
                        const url = result.info.secure_url;
                        urlInput.value = url; 
                        previewImg.src = url; 
                        previewImg.classList.remove('hidden'); 
                        alert("GÃ¶rsel yÃ¼klendi ve URL kaydedildi.");
                    } else if (error) {
                        console.error("Cloudinary yÃ¼kleme hatasÄ±:", error);
                        alert("GÃ¶rsel yÃ¼klenirken bir hata oluÅŸtu: " + error.message);
                    }
                }
            );
            widget.open();
        }
        
        async function updateProductInFirebase(key, updates) {
            updates.lastUpdated = Date.now(); 
            // productsRef dinamik olduÄŸu iÃ§in doÄŸru yola yazacak.
            await productsRef.child(key).update(updates);
        }

        async function deleteProductFromFirebase(key) {
            // productsRef dinamik olduÄŸu iÃ§in doÄŸru yoldan silecek.
            await productsRef.child(key).remove();
        }
        
        async function deleteCampaignUrl(key) {
             // campaignsRef dinamik olduÄŸu iÃ§in doÄŸru yoldan silecek.
             await campaignsRef.child(key).remove();
        }
        
        function sortProductsByOrder(productsArray) {
            return productsArray.sort((a, b) => (a.order === undefined ? 9999 : a.order) - (b.order === undefined ? 9999 : b.order));
        }

        // --- MODÃœL: ÃœRÃœN YÃ–NETÄ°MÄ° (PRODUCTS) ---
        function renderProductsModule() {
            setActiveTab('showProducts');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“¦ ${menuTitle} ÃœrÃ¼n YÃ¶netimi</h2>
                <div class="flex gap-4 mb-4">
                    <select id="filterCategory" class="border p-2 rounded flex-1">
                        <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <ul id="productList" class="flex flex-col gap-3">
                    <li class="p-4 bg-white rounded shadow text-gray-500">ÃœrÃ¼nler yÃ¼kleniyor...</li>
                </ul>
            `);
            const filterSelect = document.getElementById('filterCategory');
            filterSelect.addEventListener('change', () => renderProductList(filterSelect.value));
            if (products.length > 0) {
                 renderProductList(filterSelect.value);
            }
        }

        function renderProductList(filter='TÃ¼mÃ¼') {
            const listEl = document.getElementById('productList');
            if (!listEl) return;
            listEl.innerHTML = '';
            
            const sortedProducts = sortProductsByOrder([...products]); 
            const filtered = filter === 'TÃ¼mÃ¼' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                listEl.innerHTML = '<li class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride Ã¼rÃ¼n bulunmamaktadÄ±r.</li>';
                return;
            }

            filtered.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'flex justify-between items-center bg-white p-3 rounded border shadow-sm';
                item.innerHTML = `
                    <span class="font-medium text-base">${p.name} (${p.category}) - ${p.price} â‚º</span>
                    <div>
                        <button data-key="${p.key}" class="editBtn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition mr-2">DÃ¼zenle</button>
                        <button data-key="${p.key}" class="deleteBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const productKeyToDelete = e.target.dataset.key;
                    if (confirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?")) {
                        try { await deleteProductFromFirebase(productKeyToDelete); alert("ÃœrÃ¼n silindi."); } 
                        catch (error) { alert("Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu: " + error.message); }
                    }
                });
            });
            document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', (e) => openEditModal(e.target.dataset.key)));
        }

        // --- MODÃœL: ÃœRÃœN SIRALAMA AYARI (SORTING) ---
        
        function renderSortingModule() {
            if (typeof Sortable === 'undefined') {
                alert("Hata: ÃœrÃ¼n sÄ±ralama Ã¶zelliÄŸi iÃ§in gerekli kÃ¼tÃ¼phane (Sortable.js) yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                return;
            }
            
            setActiveTab('showSorting');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">â¬†ï¸ ${menuTitle} ÃœrÃ¼n SÄ±ralama AyarÄ±</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">ÃœrÃ¼nleri sÃ¼rÃ¼kleyip bÄ±rakarak menÃ¼deki sÄ±ralamasÄ±nÄ± deÄŸiÅŸtirebilirsiniz. Bu ayar tÃ¼m dillerde geÃ§erli olacaktÄ±r.</p>
                    
                    <label class="block mb-2 font-semibold text-sm">SÄ±ralanacak Kategori SeÃ§in:</label>
                    <select id="sortCategory" class="border p-2 rounded w-full mb-6">
                        <option value="">-- Kategori SeÃ§iniz --</option>
                        <option value="TÃ¼mÃ¼">TÃ¼mÃ¼ (TÃ¼m ÃœrÃ¼nler)</option> ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <ul id="sortableList" class="flex flex-col gap-2 p-2 border rounded bg-gray-50 min-h-[100px]">
                        <li class="text-gray-500 text-center py-4">LÃ¼tfen yukarÄ±dan bir kategori seÃ§iniz.</li>
                    </ul>
                    
                    <button id="saveSorting" class="mt-6 bg-green-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-green-600 transition w-full hidden">Yeni SÄ±ralamayÄ± Kaydet</button>
                    <p id="sortingStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);
            
            // Event Listeners
            const sortCategorySelect = document.getElementById('sortCategory');
            sortCategorySelect.addEventListener('change', (e) => loadSortableList(e.target.value));
            document.getElementById('saveSorting').addEventListener('click', saveSortingOrder);
        }
        
        // Kategori seÃ§ildiÄŸinde sÃ¼rÃ¼kle-bÄ±rak listesini yÃ¼kler
        function loadSortableList(category) {
            const listEl = document.getElementById('sortableList');
            const saveBtn = document.getElementById('saveSorting');
            const statusEl = document.getElementById('sortingStatus');
            statusEl.classList.add('hidden');
            saveBtn.classList.add('hidden');
            listEl.innerHTML = '';
            
            if (!category || products.length === 0) {
                listEl.innerHTML = `<li class="text-gray-500 text-center py-4">${products.length === 0 ? 'ÃœrÃ¼n verileri yÃ¼kleniyor...' : 'LÃ¼tfen yukarÄ±dan bir kategori seÃ§iniz.'}</li>`;
                return;
            }
            
            const filteredProducts = category === 'TÃ¼mÃ¼'
                ? products
                : products.filter(p => p.category === category);
            
            const filteredAndSorted = sortProductsByOrder(filteredProducts);


            if (filteredAndSorted.length === 0) {
                listEl.innerHTML = `<li class="text-gray-500 text-center py-4">"${category}" kategorisinde Ã¼rÃ¼n bulunmamaktadÄ±r.</li>`;
                return;
            }
            
            filteredAndSorted.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'sortable-item flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-200';
                item.dataset.id = p.key; 
                item.innerHTML = `
                    <span class="text-gray-400 mr-3">â˜°</span>
                    <span class="font-medium text-base flex-1">${p.name}</span>
                    <span class="text-orange-600 font-semibold">${p.price} â‚º</span>
                `;
                listEl.appendChild(item);
            });
            
            saveBtn.classList.remove('hidden');

            Sortable.create(listEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    statusEl.textContent = 'SÄ±ralama deÄŸiÅŸtirildi. Kaydet butonuna basmayÄ± unutmayÄ±n!';
                    statusEl.classList.remove('hidden');
                    statusEl.classList.remove('text-green-600');
                    statusEl.classList.add('text-red-600');
                },
            });
        }
        
        // Yeni sÄ±ralama dÃ¼zenini (order deÄŸerlerini) Firebase'e kaydeder
        async function saveSortingOrder() {
            const listEl = document.getElementById('sortableList');
            const items = listEl.children;
            const updates = {};
            const statusEl = document.getElementById('sortingStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceProductsPath : deliveryProductsPath;
            
            if (items.length === 0) return;
            
            for (let i = 0; i < items.length; i++) {
                const productKey = items[i].dataset.id;
                const newOrderValue = i; 
                
                const currentProduct = products.find(p => p.key === productKey);
                
                if (currentProduct && currentProduct.order !== newOrderValue) {
                    // Dinamik yolu burada kullanÄ±yoruz
                    updates[`${pathPrefix}/${productKey}/order`] = newOrderValue; 
                    changesMade++;
                }
            }
            
            if (changesMade === 0) {
                 statusEl.textContent = 'Herhangi bir sÄ±ralama deÄŸiÅŸikliÄŸi tespit edilmedi.';
                 statusEl.classList.remove('text-red-600');
                 statusEl.classList.add('text-green-600');
                 statusEl.classList.remove('hidden');
                 return;
            }
            
            if (!confirm(`${changesMade} Ã¼rÃ¼nÃ¼n sÄ±ralamasÄ± gÃ¼ncellenecektir. OnaylÄ±yor musunuz?`)) {
                return;
            }

            try {
                await database.ref().update(updates); 
                
                statusEl.textContent = `${changesMade} Ã¼rÃ¼n sÄ±ralamasÄ± baÅŸarÄ±yla kaydedildi.`;
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                statusEl.classList.remove('hidden');
                
                const currentCategory = document.getElementById('sortCategory').value;
                loadSortableList(currentCategory); 

            } catch (error) {
                statusEl.textContent = 'SÄ±ralamayÄ± kaydetme baÅŸarÄ±sÄ±z oldu: ' + error.message;
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.remove('hidden');
            }
        }

        // --- MODÃœL: KAMPANYA GÃ–RSELLERÄ° YÃ–NETÄ°MÄ° ---

        function renderCampaignModule() {
    setActiveTab('showCampaigns');
    const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
    loadModule(`
        <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ–¼ï¸ ${menuTitle} Kampanya YÃ¶netimi</h2>
        <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
            
            <div class="border p-4 mb-6 rounded-lg bg-orange-50 border-orange-200">
                <h3 class="font-bold mb-3 text-orange-700">Yeni Kampanya Ekle</h3>
                
                <div class="mb-3">
                    <label class="block text-sm font-semibold mb-1">1. GÃ¶rsel SeÃ§in</label>
                    <button id="uploadNewCampaignImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full">GÃ¶rsel YÃ¼kle (Cloudinary)</button>
                    <img id="newCampaignImagePreview" class="campaign-image-preview hidden" src="" alt="Ã–nizleme">
                    <input type="hidden" id="newCampaignImageURL" value="" />
                </div>

                <div class="mb-3">
                    <label class="block text-sm font-semibold mb-1">2. Fiyat Girin (Kutucuk Ä°Ã§in)</label>
                    <input id="newCampaignPriceInput" type="text" placeholder="Ã–rn: 250 â‚º" class="border p-2 rounded w-full font-bold text-lg" />
                    <p class="text-xs text-gray-500 mt-1">Bu fiyat sol alttaki turuncu alanda gÃ¶rÃ¼necektir.</p>
                </div>

                <button id="addCampaignUrlBtn" class="mt-2 bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 transition w-full font-bold hidden">âœ… Listeye Kaydet</button>
            </div>

            <h3 class="font-bold text-xl mb-3 text-gray-800">YayÄ±ndaki Kampanyalar (${campaignUrls.length} Adet)</h3>
            <p class="mb-3 text-sm text-gray-500">SÄ±ralamayÄ± deÄŸiÅŸtirmek iÃ§in sÃ¼rÃ¼kleyip bÄ±rakÄ±n, fiyatÄ± deÄŸiÅŸtirmek iÃ§in kutucuÄŸa yazÄ±p "GÃ¼ncelle" deyin.</p>
            
            <ul id="sortableCampaignList" class="flex flex-col gap-4 p-2 border rounded bg-gray-50 min-h-[50px]">
            </ul>

            <button id="saveCampaignSorting" class="mt-4 bg-gray-800 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-gray-900 transition w-full hidden">SÄ±ralamayÄ± Kaydet</button>
            <p id="campaignSortingStatus" class="mt-2 text-center text-sm text-green-600 hidden"></p>
        </div>
    `);
    
    // GÃ¶rsel YÃ¼kleme Butonu
    const urlInput = document.getElementById('newCampaignImageURL');
    const previewImg = document.getElementById('newCampaignImagePreview');
    const addBtn = document.getElementById('addCampaignUrlBtn');
    
    document.getElementById('uploadNewCampaignImageBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openCloudinaryWidget(urlInput, previewImg);
        // Widget kapandÄ±ÄŸÄ±nda ve urlInput dolduÄŸunda butonu gÃ¶ster
        const observer = new MutationObserver(() => {
            if(urlInput.value) addBtn.classList.remove('hidden');
        });
        observer.observe(urlInput, { attributes: true });
    });

    addBtn.addEventListener('click', addCampaignUrl);
    
    // SÄ±ralama Kaydetme Butonu
    document.getElementById('saveCampaignSorting').addEventListener('click', saveCampaignSortingOrder);
    
    renderCampaignList();
}
        
        // Mevcut Kampanya GÃ¶rsellerini Listeler ve SÄ±ralamayÄ± Ayarlar
       function renderCampaignList() {
    const listEl = document.getElementById('sortableCampaignList');
    const saveBtn = document.getElementById('saveCampaignSorting');
    const statusEl = document.getElementById('campaignSortingStatus');
    if (!listEl) return;
    
    const sortedCampaigns = [...campaignUrls].sort((a, b) => 
        (a.order === undefined ? 9999 : a.order) - (b.order === undefined ? 9999 : b.order)
    );
    
    listEl.innerHTML = '';
    saveBtn.classList.add('hidden');
    statusEl.classList.add('hidden');

    if (sortedCampaigns.length === 0) {
        listEl.innerHTML = '<li class="text-gray-500 text-center py-4">HenÃ¼z kampanya gÃ¶rseli eklenmedi.</li>';
        return;
    }
    
    saveBtn.classList.remove('hidden');

    sortedCampaigns.forEach((c) => {
        const item = document.createElement('li');
        item.className = 'sortable-item bg-white p-3 rounded shadow-sm border border-gray-200';
        item.dataset.id = c.key; 
        
        // Fiyat deÄŸeri yoksa boÅŸ string olsun
        const priceValue = c.price || "";

        item.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-gray-400 cursor-grab text-xl">â˜°</span>
                <img src="${c.url}" class="w-20 h-12 object-cover rounded border">
                
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-500 block">Fiyat:</label>
                    <div class="flex gap-2">
                        <input type="text" class="campaign-price-edit border p-1 rounded w-full text-sm font-bold text-orange-600" value="${priceValue}" placeholder="Fiyat Girin">
                        <button class="updatePriceBtn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition">GÃ¼ncelle</button>
                    </div>
                </div>

                <button data-key="${c.key}" class="deleteCampaignBtn bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 transition">ğŸ—‘ï¸</button>
            </div>
        `;
        listEl.appendChild(item);
    });

    // Sortable JS Uygula
    Sortable.create(listEl, {
        animation: 150,
        handle: '.cursor-grab',
        ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
            statusEl.textContent = 'SÄ±ralama deÄŸiÅŸti. "SÄ±ralamayÄ± Kaydet"e basÄ±n.';
            statusEl.classList.remove('hidden', 'text-green-600');
            statusEl.classList.add('text-red-600');
        },
    });

    // Fiyat GÃ¼ncelleme ButonlarÄ±
    document.querySelectorAll('.updatePriceBtn').forEach((btn, index) => {
        btn.addEventListener('click', async (e) => {
            const li = e.target.closest('li');
            const key = li.dataset.id;
            const newPrice = li.querySelector('.campaign-price-edit').value;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceCampaignsPath : deliveryCampaignsPath;
            
            try {
                await database.ref(`${pathPrefix}/${key}/price`).set(newPrice);
                alert('Fiyat gÃ¼ncellendi!');
            } catch(err) {
                alert('Hata: ' + err.message);
            }
        });
    });

    // Silme ButonlarÄ±
    document.querySelectorAll('.deleteCampaignBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const keyToDelete = e.target.dataset.key;
            if (confirm("Bu kampanyayÄ± silmek istediÄŸinizden emin misiniz?")) {
                try { 
                    await deleteCampaignUrl(keyToDelete); 
                    // Silindikten sonra renderCampaignList otomatik tetiklenir (on('value') sayesinde)
                } catch (error) { 
                    alert("Hata: " + error.message); 
                }
            }
        });
    });
}

// YENÄ° KAMPANYA EKLEME (FiyatlÄ±)
async function addCampaignUrl() {
    const url = document.getElementById('newCampaignImageURL').value.trim();
    const price = document.getElementById('newCampaignPriceInput').value.trim();

    if (!url) {
        alert('LÃ¼tfen Ã¶nce bir gÃ¶rsel yÃ¼kleyin.');
        return;
    }
    
    const maxOrder = campaignUrls.length > 0 
        ? Math.max(...campaignUrls.map(c => c.order === undefined ? 0 : c.order))
        : 0;

    try {
        await campaignsRef.push({ 
            url: url, 
            price: price, // FiyatÄ± da kaydediyoruz
            timestamp: Date.now(),
            order: maxOrder + 1 
        }); 
        alert("Kampanya baÅŸarÄ±yla eklendi.");
        
        // Formu temizle
        document.getElementById('newCampaignImageURL').value = '';
        document.getElementById('newCampaignPriceInput').value = '';
        document.getElementById('newCampaignImagePreview').src = '';
        document.getElementById('newCampaignImagePreview').classList.add('hidden');
        document.getElementById('addCampaignUrlBtn').classList.add('hidden');
        
    } catch (error) {
        alert("Hata: " + error.message);
    }
}
        
        // KampanyalarÄ±n Yeni SÄ±ralama DÃ¼zenini Kaydeder
        async function saveCampaignSortingOrder() {
            const listEl = document.getElementById('sortableCampaignList');
            const items = listEl.children;
            const updates = {};
            const statusEl = document.getElementById('campaignSortingStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceCampaignsPath : deliveryCampaignsPath;

            if (items.length === 0) return;
            
            for (let i = 0; i < items.length; i++) {
                const campaignKey = items[i].dataset.id;
                const newOrderValue = i; 
                
                const currentCampaign = campaignUrls.find(c => c.key === campaignKey);
                
                if (currentCampaign && currentCampaign.order !== newOrderValue) {
                    // Dinamik yolu burada kullanÄ±yoruz
                    updates[`${pathPrefix}/${campaignKey}/order`] = newOrderValue; 
                    changesMade++;
                }
            }
            
            if (changesMade === 0) {
                 statusEl.textContent = 'Herhangi bir sÄ±ralama deÄŸiÅŸikliÄŸi tespit edilmedi.';
                 statusEl.classList.remove('text-red-600');
                 statusEl.classList.add('text-green-600');
                 statusEl.classList.remove('hidden');
                 return;
            }
            
            if (!confirm(`${changesMade} kampanya gÃ¶rselinin sÄ±ralamasÄ± gÃ¼ncellenecektir. OnaylÄ±yor musunuz?`)) {
                return;
            }

            try {
                // TÃ¼m gÃ¼ncellemeleri tek seferde Firebase'e gÃ¶nder
                await database.ref().update(updates); 
                
                statusEl.textContent = `${changesMade} kampanya sÄ±ralamasÄ± baÅŸarÄ±yla kaydedildi.`;
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                statusEl.classList.remove('hidden');

            } catch (error) {
                statusEl.textContent = 'SÄ±ralamayÄ± kaydetme baÅŸarÄ±sÄ±z oldu: ' + error.message;
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.remove('hidden');
            }
        }


        // --- MODÃœL: YENÄ° ÃœRÃœN EKLEME (ADD PRODUCT) ---
        function renderAddProductModule() {
            setActiveTab('showAddProduct');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">â• ${menuTitle} Yeni ÃœrÃ¼n Ekle</h2>
                <div class="flex flex-col gap-4 p-6 border rounded-lg bg-white shadow-md max-w-lg">
                    <input id="productName" placeholder="ÃœrÃ¼n AdÄ± (TR)" class="border p-3 rounded" />
                    <input id="productNameEN" placeholder="Product Name (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productDesc" placeholder="AÃ§Ä±klama (TR)" class="border p-3 rounded" />
                    <input id="productDescEN" placeholder="Description (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productPrice" type="number" placeholder="Fiyat (â‚º)" class="border p-3 rounded" />
                    <select id="productCategory" class="border p-3 rounded">
                        <option value="">-- Kategori SeÃ§iniz --</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold mb-2">GÃ¶rsel YÃ¼kle (Opsiyonel)</h3>
                        <button id="uploadNewImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full">GÃ¶rsel YÃ¼kle</button>
                        <img id="newImagePreview" class="w-full h-32 object-cover rounded-lg mt-3 border border-gray-300" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>GÃ¶rsel Yok</text></svg>" alt="Yeni GÃ¶rsel Ã–nizleme">
                        <input type="hidden" id="productImageURL" value="" />
                    </div>
                    
                    <button id="addProduct" class="bg-orange-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-orange-600 transition">ÃœrÃ¼nÃ¼ Kaydet</button>
                </div>
            `);
            // Event Listener'lar
            document.getElementById('uploadNewImageBtn').addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(document.getElementById('productImageURL'), document.getElementById('newImagePreview'));
            });
            document.getElementById('addProduct').addEventListener('click', addProduct);

            document.getElementById('newImagePreview').src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>GÃ¶rsel Yok</text></svg>";
        }

        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const nameEN = document.getElementById('productNameEN').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const descEN = document.getElementById('productDescEN').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            
            let imageURL = document.getElementById('productImageURL').value.trim(); 
            
            if (!imageURL) { imageURL = ''; }

            if (!name || isNaN(price) || !category) { 
                alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± (Ad, Fiyat ve Kategori) doldurunuz.'); return; 
            }
            
            const maxOrder = products.length > 0 
                ? Math.max(...products.map(p => p.order === undefined ? 0 : p.order))
                : 0;
            
            const newProduct = {
                name, nameEN: nameEN || name, desc, descEN: descEN || desc,
                price, image: imageURL, category, 
                lastUpdated: Date.now(),
                order: maxOrder + 1 
            };

            try {
                // productsRef dinamik olduÄŸu iÃ§in doÄŸru yola yazacak.
                await productsRef.push(newProduct); 
                alert(`"${name}" Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla eklendi.`);
                
                document.querySelectorAll('#contentContainer input, #contentContainer select').forEach(el => el.value = '');
                document.getElementById('productImageURL').value = ''; 
                
                const previewImg = document.getElementById('newImagePreview');
                previewImg.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>GÃ¶rsel Yok</text></svg>";
                
            } catch (error) {
                alert("Ekleme iÅŸlemi baÅŸarÄ±sÄ±z oldu: " + error.message);
            }
        }

        // --- MODÃœL: TOPLU FÄ°YAT DEÄÄ°ÅTÄ°RME (BULK UPDATE) ---
        function renderBulkUpdateModule() {
            setActiveTab('showBulkUpdate');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ’¸ ${menuTitle} Toplu Fiyat DeÄŸiÅŸtirme</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">AÅŸaÄŸÄ±daki listede Ã¼rÃ¼nlerin mevcut fiyatlarÄ±nÄ± deÄŸiÅŸtirebilir veya Toplu DeÄŸiÅŸim araÃ§larÄ±nÄ± kullanabilirsiniz. **Yeni fiyatlarÄ± manuel olarak sÄ±ra sÄ±ra da girebilirsiniz.**</p>
                    
                    <div class="border p-4 mb-6 rounded-lg bg-gray-50">
                        <h3 class="font-bold mb-3 text-orange-600">Toplu DeÄŸiÅŸim AraÃ§larÄ±</h3>
                        <label class="block mb-2 font-semibold text-sm">Uygulanacak Kategori:</label>
                        <select id="bulkCategory" class="border p-2 rounded w-full mb-3">
                            <option value="TÃ¼mÃ¼">TÃ¼m ÃœrÃ¼nler</option>
                            ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>

                        <label class="block mb-2 font-semibold text-sm">DeÄŸiÅŸim Tipi:</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center"><input type="radio" name="updateType" value="percent" checked class="mr-2"> YÃ¼zdesel (%)</label>
                            <label class="flex items-center"><input type="radio" name="updateType" value="fixed" class="mr-2"> Sabit DeÄŸer (â‚º)</label>
                        </div>

                        <input id="updateValue" type="number" placeholder="Ã–rn: 10 (â‚º10 artÄ±ÅŸ) veya -5 (%5 indirim)" class="border p-2 rounded w-full mb-4" />
                        
                        <button id="applyBulkAdjustment" class="bg-blue-500 text-white px-4 py-2 rounded font-semibold hover:bg-blue-600 transition w-full">SeÃ§ili ÃœrÃ¼nlere Toplu Ayar Uygula</button>
                    </div>

                    <h3 class="font-bold text-xl mb-3 text-gray-800">ÃœrÃ¼n FiyatlarÄ±nÄ± Manuel DÃ¼zenle</h3>
                    <div class="flex font-bold text-sm bg-gray-100 p-2 rounded mb-2">
                        <span class="w-1/2">ÃœrÃ¼n AdÄ±</span>
                        <span class="w-1/4 text-right">Mevcut Fiyat</span>
                        <span class="w-1/4 text-right">Yeni Fiyat (â‚º)</span>
                    </div>
                    <form id="bulkUpdateForm" class="flex flex-col gap-2">
                        <p class="text-gray-500">ÃœrÃ¼nler yÃ¼kleniyor...</p>
                        </form>
                    
                    <button id="saveManualPrices" class="mt-6 bg-red-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-red-600 transition w-full">GirdiÄŸim Yeni FiyatlarÄ± Kaydet</button>
                    <p id="bulkStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);

            // Event Listener'lar
            document.getElementById('bulkCategory').addEventListener('change', () => renderBulkPriceList(document.getElementById('bulkCategory').value));
            document.getElementById('applyBulkAdjustment').addEventListener('click', applyBulkAdjustment);
            document.getElementById('saveManualPrices').addEventListener('click', saveManualPrices);
            
            renderBulkPriceList(document.getElementById('bulkCategory').value);
        }
        
        // Toplu fiyat listesini dÃ¼zenlenebilir inputlarla render eder
        function renderBulkPriceList(filter='TÃ¼mÃ¼') {
            const formEl = document.getElementById('bulkUpdateForm');
            if (!formEl) return;
            formEl.innerHTML = '';
            
            const sortedProducts = sortProductsByOrder([...products]);

            const filtered = filter === 'TÃ¼mÃ¼' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                formEl.innerHTML = '<p class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
                return;
            }

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-white p-2 rounded border text-sm';
                item.innerHTML = `
                    <span class="w-1/2">${p.name}</span>
                    <span class="w-1/4 text-right font-medium">${p.price} â‚º</span>
                    <input 
                        type="number" 
                        step="1" 
                        placeholder="${p.price}" 
                        value="${p.price}"
                        data-key="${p.key}" 
                        class="bulk-price-input w-1/4 text-right border p-1 rounded focus:border-orange-500"
                    />
                `;
                formEl.appendChild(item);
            });
        }

        // Toplu yÃ¼zdesel/sabit ayarÄ± input alanlarÄ±na uygular
        function applyBulkAdjustment() {
            const updateType = document.querySelector('input[name="updateType"]:checked').value;
            const value = parseFloat(document.getElementById('updateValue').value);
            const statusEl = document.getElementById('bulkStatus');
            statusEl.classList.add('hidden');

            if (isNaN(value) || value === 0) {
                statusEl.textContent = 'LÃ¼tfen geÃ§erli bir deÄŸiÅŸim deÄŸeri girin.';
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            let updatedCount = 0;

            inputs.forEach(input => {
                const productKey = input.dataset.key;
                const currentProduct = products.find(p => p.key === productKey);
                if (!currentProduct) return;

                let newPrice;
                const basePrice = currentProduct.price; 

                if (updateType === 'percent') {
                    newPrice = basePrice * (1 + (value / 100));
                } else { // fixed
                    newPrice = basePrice + value;
                }
                newPrice = Math.max(0, newPrice); // Max 0'dan bÃ¼yÃ¼k olmalÄ±
                
                input.value = parseFloat(newPrice.toFixed(2)); // Ä°ki ondalÄ±k basamaÄŸa yuvarla
                updatedCount++;
            });

            if (updatedCount > 0) {
                statusEl.textContent = `${updatedCount} Ã¼rÃ¼nÃ¼n fiyatÄ± gÃ¼ncellendi. LÃ¼tfen "Kaydet" butonuna basarak deÄŸiÅŸiklikleri veritabanÄ±na iÅŸleyin.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
            } else {
                 statusEl.textContent = 'GÃ¼ncellenecek Ã¼rÃ¼n bulunamadÄ±.';
                 statusEl.classList.remove('hidden');
                 statusEl.classList.remove('text-green-600');
                 statusEl.classList.add('text-red-600');
            }
        }


        // Manuel girilen fiyatlarÄ± Firebase'e kaydeder
        async function saveManualPrices() {
            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            const updates = {};
            const currentTime = Date.now();
            const statusEl = document.getElementById('bulkStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceProductsPath : deliveryProductsPath;
            let invalidPrices = []; // GeÃ§ersiz fiyatlarÄ± tutacak dizi


            if (inputs.length === 0) {
                statusEl.textContent = 'Kaydedilecek Ã¼rÃ¼n bulunamadÄ±.';
                statusEl.classList.remove('hidden', 'text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            for (const input of inputs) {
                const productKey = input.dataset.key;
                const newPrice = parseFloat(input.value);
                const currentProduct = products.find(p => p.key === productKey);

                if (isNaN(newPrice) || newPrice < 0) {
                    invalidPrices.push(currentProduct.name);
                    continue; // GeÃ§ersiz fiyatÄ± atla, diÄŸerlerini kaydetmeye devam et
                }
                
                const currentPriceRounded = parseFloat(currentProduct.price.toFixed(2));
                const newPriceRounded = parseFloat(newPrice.toFixed(2));


                if (currentProduct && currentPriceRounded !== newPriceRounded) {
                    // Dinamik yolu burada kullanÄ±yoruz
                    updates[`${pathPrefix}/${productKey}/price`] = newPriceRounded;
                    updates[`${pathPrefix}/${productKey}/lastUpdated`] = currentTime; 
                    changesMade++;
                }
            }
            
            // Hata KontrolÃ¼
            if (invalidPrices.length > 0) {
                alert(`AÅŸaÄŸÄ±daki Ã¼rÃ¼nler iÃ§in geÃ§ersiz fiyat girdiniz ve kaydedilemediler: \n- ${invalidPrices.join('\n- ')}\n\nDiÄŸer geÃ§erli fiyatlar kaydedilmeye devam ediliyor.`);
            }


            if (changesMade === 0) {
                statusEl.textContent = 'Herhangi bir fiyat deÄŸiÅŸikliÄŸi tespit edilmedi.';
                statusEl.classList.remove('hidden', 'text-red-600');
                statusEl.classList.add('text-green-600');
                return;
            }
            
            if (!confirm(`${changesMade} Ã¼rÃ¼nÃ¼n fiyatÄ± gÃ¼ncellenecektir. OnaylÄ±yor musunuz?`)) {
                return;
            }

            try {
                await database.ref().update(updates); 
                statusEl.textContent = `${changesMade} Ã¼rÃ¼n fiyatÄ± baÅŸarÄ±yla kaydedildi ve menÃ¼ gÃ¼ncellendi.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                // Fiyatlar gÃ¼ncellendiÄŸi iÃ§in listeyi yeniden render et
                renderBulkPriceList(document.getElementById('bulkCategory').value);
            } catch (error) {
                statusEl.textContent = 'FiyatlarÄ± kaydetme baÅŸarÄ±sÄ±z oldu: ' + error.message;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
            }
        }
        
        // --- MODÃœL: Ä°STATÄ°STÄ°KLER (STATS) ---
        function renderStatsModule() {
            setActiveTab('showStats');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde MenÃ¼' : 'Paket Servis MenÃ¼sÃ¼';
            
            // NOTE: ZiyaretÃ§i takibi tek bir 'visitors' yolunda tutuluyor.
            // Bu yÃ¼zden menÃ¼ye Ã¶zel bir ziyaretÃ§i sayacÄ± ÅŸimdilik yok.
            
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“Š MenÃ¼ GÃ¶rÃ¼ntÃ¼leme Ä°statistikleri</h2>
                <div class="grid grid-cols-2 gap-6 max-w-xl">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">BugÃ¼nkÃ¼ GÃ¶rÃ¼ntÃ¼leme</h3>
                        <p id="todayCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">Toplam GÃ¶rÃ¼ntÃ¼leme</h3>
                        <p id="totalCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="resetCounter" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">SayaÃ§larÄ± SÄ±fÄ±rla (TÃ¼m Zamanlar)</button>
                    <p class="text-sm text-gray-500 mt-2">NOT: Bu sayaÃ§lar, ${currentMenuType === 'in_place' ? 'index.html' : 'delivery.html'} dosyasÄ±nÄ±n kaÃ§ kez aÃ§Ä±ldÄ±ÄŸÄ±nÄ± gÃ¶sterir. SÄ±fÄ±rlama tÃ¼m geÃ§miÅŸi siler.</p>
                </div>
            `);
            fetchVisitorCounts();
            document.getElementById('resetCounter').addEventListener('click', resetVisitorCounts);
        }

        function fetchVisitorCounts() {
            const today = new Date().toISOString().slice(0, 10);
            
            // ZiyaretÃ§i referansÄ± sabit olduÄŸu iÃ§in burada dinamik bir deÄŸiÅŸiklik yapmaya gerek yok.
            // Ancak, gerÃ§ek bir ayrÄ±m iÃ§in 'visitors/in_place' ve 'visitors/delivery' gibi yollar kullanÄ±lmalÄ±dÄ±r.
            visitorsRef.child(today).once('value', snapshot => {
                document.getElementById('todayCount').textContent = snapshot.val() || 0;
            });

            visitorsRef.once('value', snapshot => {
                let total = 0;
                snapshot.forEach(child => {
                    total += child.val();
                });
                document.getElementById('totalCount').textContent = total;
            });
        }
        
        async function resetVisitorCounts() {
            if (confirm("TÃ¼m ziyaretÃ§i verilerini sÄ±fÄ±rlamak istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.")) {
                try {
                    await visitorsRef.remove();
                    alert("ZiyaretÃ§i sayaÃ§larÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.");
                    fetchVisitorCounts(); 
                } catch (error) {
                    alert("SayaÃ§ sÄ±fÄ±rlama baÅŸarÄ±sÄ±z oldu: " + error.message);
                }
            }
        }

        // --- EDÄ°T MODAL ORTAK KULLANIM FONKSÄ°YONLARI ---
        function openEditModal(productKey) {
            const productToEdit = products.find(p => p.key === productKey);
            
            if (productToEdit) {
                document.getElementById('editProductKey').value = productKey; 
                document.getElementById('editName').value = productToEdit.name;
                document.getElementById('editNameEN').value = productToEdit.nameEN || '';
                document.getElementById('editDesc').value = productToEdit.desc || '';
                document.getElementById('editDescEN').value = productToEdit.descEN || '';
                document.getElementById('editPrice').value = productToEdit.price;
                
                const editCategorySelect = document.getElementById('editCategory');
                editCategorySelect.innerHTML = categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                editCategorySelect.value = productToEdit.category;
                
                editImageURLInput.value = productToEdit.image;
                editImagePreview.src = productToEdit.image;
                
                editProductModal.classList.remove('hidden');
            }
        }
        
        // --- FIREBASE DINLEYICILERI YÃ–NETÄ°MÄ° ---
        
        // Dinleyicileri tutmak iÃ§in boÅŸ bir nesne
        let activeListeners = {}; 
        
        function stopAllListeners() {
            // Ã–nceki dinleyicileri kapat (off metodu ile)
            if (activeListeners.products) productsRef.off('value', activeListeners.products);
            if (activeListeners.campaigns) campaignsRef.off('value', activeListeners.campaigns);
            if (activeListeners.campaignPriceText) campaignInfoRef.child('price_text').off('value', activeListeners.campaignPriceText);
            if (activeListeners.priceBoxUrl) priceBoxUrlRef.off('value', activeListeners.priceBoxUrl);
            
            activeListeners = {}; // Nesneyi temizle
        }
        
        function setupDataListeners() {
             // Firebase Dinleyicisi (ÃœrÃ¼nler)
            activeListeners.products = productsRef.on('value', (snapshot) => {
                products = [];
                snapshot.forEach(childSnapshot => {
                    const product = childSnapshot.val();
                    product.key = childSnapshot.key;
                    products.push(product);
                });
                
                const activeTab = document.querySelector('.tab-button.active');
                if (activeTab) {
                    const activeId = activeTab.id;
                    
                    if (activeId === 'showProducts') {
                        const filterSelect = document.getElementById('filterCategory');
                        if (filterSelect) renderProductList(filterSelect.value);
                    } else if (activeId === 'showBulkUpdate') {
                        const bulkSelect = document.getElementById('bulkCategory');
                        if (bulkSelect) renderBulkPriceList(bulkSelect.value);
                    } else if (activeId === 'showSorting') {
                        const sortSelect = document.getElementById('sortCategory');
                        if (sortSelect && sortSelect.value) loadSortableList(sortSelect.value);
                    }
                }
            });

            // Firebase Dinleyicisi (Kampanya GÃ¶rselleri)
            activeListeners.campaigns = campaignsRef.on('value', (snapshot) => {
                 campaignUrls = [];
                 snapshot.forEach(childSnapshot => {
                     const campaign = childSnapshot.val();
                     campaign.key = childSnapshot.key;
                     campaignUrls.push(campaign);
                 });
                 if (document.getElementById('sortableCampaignList')) { 
                     renderCampaignList();
                 }
            });
            
            // Firebase Dinleyicisi (Kampanya Fiyat Metni)
            activeListeners.campaignPriceText = campaignInfoRef.child('price_text').on('value', (snapshot) => {
                 campaignPriceText = snapshot.val() || "";
                 const inputEl = document.getElementById('campaignPriceTextInput');
                 if(inputEl) {
                     inputEl.value = campaignPriceText;
                 }
            });
            
            // Firebase Dinleyicisi (Fiyat KutucuÄŸu GÃ¶rseli URL'si)
            activeListeners.priceBoxUrl = priceBoxUrlRef.on('value', (snapshot) => {
                 campaignPriceBoxUrl = snapshot.val() || "";
                 const inputEl = document.getElementById('priceBoxImageURL');
                 const previewEl = document.getElementById('priceBoxImagePreview');
                 if(inputEl) {
                     inputEl.value = campaignPriceBoxUrl;
                 }
                 if(previewEl) {
                     previewEl.src = campaignPriceBoxUrl;
                     if(campaignPriceBoxUrl) {
                        previewEl.classList.remove('hidden');
                     } else {
                        previewEl.classList.add('hidden');
                     }
                 }
            });
        }


        // --- GENEL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // BaÅŸlangÄ±Ã§ta Yerinde MenÃ¼ referanslarÄ±nÄ± ayarla ve dinleyicileri baÅŸlat.
            setFirebaseRefs('in_place'); 
            
            // Navigasyon ButonlarÄ±
            showProductsBtn.addEventListener('click', renderProductsModule);
            showSortingBtn.addEventListener('click', renderSortingModule); 
            showCampaignsBtn.addEventListener('click', renderCampaignModule); 
            showAddProductBtn.addEventListener('click', renderAddProductModule);
            showBulkUpdateBtn.addEventListener('click', renderBulkUpdateModule);
            showStatsBtn.addEventListener('click', renderStatsModule);
            
            // YENÄ°: MenÃ¼ Tipi GeÃ§iÅŸ ButonlarÄ±
            document.getElementById('switchToInPlace').addEventListener('click', () => setFirebaseRefs('in_place'));
            document.getElementById('switchToDelivery').addEventListener('click', () => setFirebaseRefs('delivery'));
            
            // YENÄ°: Veri Kopyalama Butonu
            document.getElementById('copyToDeliveryBtn').addEventListener('click', copyMenuDataToDelivery);
            
            // Edit Modal ButonlarÄ±
            closeEditProductModal.addEventListener('click', () => editProductModal.classList.add('hidden'));
            uploadEditImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(editImageURLInput, editImagePreview);
            });
            saveEditProductButton.addEventListener('click', async () => {
                const productKey = document.getElementById('editProductKey').value;
                const updates = {
                    name: document.getElementById('editName').value.trim(),
                    nameEN: document.getElementById('editNameEN').value.trim(),
                    desc: document.getElementById('editDesc').value.trim(),
                    descEN: document.getElementById('editDescEN').value.trim(),
                    price: parseFloat(document.getElementById('editPrice').value),
                    category: document.getElementById('editCategory').value,
                    image: editImageURLInput.value.trim()
                };
                
                if (isNaN(updates.price)) { alert('LÃ¼tfen geÃ§erli bir fiyat giriniz.'); return; }

                try {
                    if (!updates.image) updates.image = ''; 

                    // updateProductInFirebase fonksiyonu dinamik referansÄ± kullanacak
                    await updateProductInFirebase(productKey, updates); 
                    editProductModal.classList.add('hidden');
                    alert(`"${updates.name}" Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla gÃ¼ncellendi.`);
                } catch (error) {
                    alert("GÃ¼ncelleme iÅŸlemi baÅŸarÄ±sÄ±z oldu: " + error.message);
                }
            });
        });
    </script>
</body>
</html>
