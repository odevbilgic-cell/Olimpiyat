<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netici Paneli | Olimpiyat Kokore√ß</title>
    
    <link rel="icon" type="image/jpeg" href="/logo.jpg"> 
    <link rel="shortcut icon" href="/logo.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        /* Aktif ana men√º butonu */
        .admin-menu-button.active { background-color: #f97316; } 
        /* Aktif sol men√º butonu */
        .tab-button.active { background-color: #fb923c; color: white; }
        /* Sƒ±ralama Mod√ºl√º ƒ∞√ßin Stiller */
        .sortable-item { cursor: grab; }
        .sortable-item:active { cursor: grabbing; }
        .sortable-ghost {
            opacity: 0.4;
            background: #ffe6cc; 
            border: 2px dashed #fb923c;
        }
        /* Kampanya G√∂rseli √ñnizlemeleri ƒ∞√ßin Yeni Stil */
        .campaign-image-preview {
            width: 100%;
            height: 120px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            border: 1px solid #d1d5db;
        }
        /* Kampanya Listesindeki G√∂rseller i√ßin */
        .campaign-item-img {
            width: 80px;
            height: 45px; 
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            margin-right: 0.75rem;
        }
        .price-box-preview-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            margin-top: 8px;
            border: 2px solid #fb923c;
            background-color: white;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <div class="w-64 bg-orange-600 text-white flex flex-col p-4 shadow-xl">
            <h1 class="text-3xl font-bold mb-4 border-b border-orange-400 pb-2">Admin Panel</h1>
            
            <div class="mb-6 border-b border-orange-400 pb-4">
                <p class="text-sm font-semibold mb-2">Y√∂netilecek Men√º:</p>
                <button id="switchToInPlace" data-menu="in_place" 
                        class="admin-menu-button active w-full text-left p-2 rounded transition mb-2">
                    üçΩÔ∏è Yerinde Men√º (products)
                </button>
                <button id="switchToDelivery" data-menu="delivery" 
                        class="admin-menu-button w-full text-left p-2 rounded hover:bg-orange-700 transition">
                    üõµ Paket Servis Men√ºs√º (delivery_products)
                </button>
            </div>
            <div id="copyToDeliveryContainer" class="mb-6 border-b border-orange-400 pb-4 hidden">
                <button id="copyToDeliveryBtn" 
                        class="bg-blue-500 text-white px-3 py-2 text-xs rounded-lg hover:bg-blue-600 transition font-bold w-full">
                    Yerinde Men√º Verilerini Kopyala
                </button>
                <p class="text-[10px] text-orange-200 mt-1">Sadece Paket Servis modunda g√∂r√ºn√ºr.</p>
            </div>


            <button id="showProducts" class="tab-button active text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                üì¶ √úr√ºn Y√∂netimi
            </button>
            <button id="showSorting" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ‚¨ÜÔ∏è √úr√ºn Sƒ±ralama Ayarƒ±
            </button>
            <button id="showCampaigns" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                üñºÔ∏è Kampanya G√∂rselleri
            </button>
            <button id="showAddProduct" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                ‚ûï Yeni √úr√ºn Ekle
            </button>
            <button id="showBulkUpdate" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                üí∏ Toplu Fiyat Deƒüi≈ütirme
            </button>
            <button id="showStats" class="tab-button text-left p-3 rounded hover:bg-orange-500 transition mb-2">
                üìä ƒ∞statistikler
            </button>
            <a href="index.html" class="mt-auto p-3 bg-red-500 text-center rounded hover:bg-red-600 transition">
                √áƒ±kƒ±≈ü Yap
            </a>
        </div>

        <main class="flex-1 p-8 overflow-y-auto">
            <div id="contentContainer">
                </div>
        </main>
    </div>

    <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-[500px] relative max-h-[90vh] overflow-y-auto">
            <button id="closeEditProductModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">‚úñ</button>
            <h2 class="text-xl font-bold mb-3 text-orange-600">√úr√ºn D√ºzenle</h2>
            
            <input type="hidden" id="editProductKey" />
            
            <div class="flex flex-col gap-3">
                <div class="p-3 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold mb-2">G√∂rsel D√ºzenleme</h3>
                    <img id="editImagePreview" class="w-full h-32 object-cover rounded-lg mb-2 border border-gray-300" src="" alt="√úr√ºn G√∂rseli √ñnizleme">
                    <button id="uploadEditImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition w-full">Yeni G√∂rsel Y√ºkle</button>
                    <input type="hidden" id="editImageURL" value="" />
                </div>

                <input id="editName" placeholder="√úr√ºn Adƒ± (TR)" class="border p-2 rounded" />
                <input id="editNameEN" placeholder="Product Name (EN)" class="border p-2 rounded" />
                <input id="editDesc" placeholder="A√ßƒ±klama (TR)" class="border p-2 rounded" />
                <input id="editDescEN" placeholder="Description (EN)" class="border p-2 rounded" />
                <input id="editPrice" type="number" placeholder="Fiyat (‚Ç∫)" class="border p-2 rounded" />
                <select id="editCategory" class="border p-2 rounded"></select>

                <button id="saveEditProduct" class="bg-green-500 text-white px-4 py-2 rounded mt-4 hover:bg-green-600 transition">Deƒüi≈üiklikleri Kaydet</button>
            </div>
        </div>
    </div>


    <script>
        // --- Sabitler ve Ayarlar ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcYNF0hMow-y1MuV3GXLG9vY_MK0tJTGs",
            authDomain: "olimpiyatkokorecmenu.firebaseapp.com",
            projectId: "olimpiyatkokorecmenu",
            messagingSenderId: "987017604417",
            appId: "1:987017604417:web:b6c4858712dc66d14745c0",
            databaseURL: "https://olimpiyatkokorecmenu-default-rtdb.europe-west1.firebasedatabase.app" 
        };
        const CLOUDINARY_CLOUD_NAME = 'dtkrwqofx';      
        const CLOUDINARY_UPLOAD_PRESET = 'olimpiyat_menu'; 

        // Firebase'i ba≈ülat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // GENEL REFERANS YOLLARI (Sabit Kalsƒ±n)
        const inPlaceProductsPath = 'products';
        const inPlaceCampaignsPath = 'campaigns';
        const inPlaceCampaignInfoPath = 'campaign_info';
        const deliveryProductsPath = 'delivery_products';
        const deliveryCampaignsPath = 'delivery_campaigns';
        const deliveryCampaignInfoPath = 'delivery_campaign_info';
        const visitorsPath = 'visitors'; // Ziyaret√ßiler her iki men√º i√ßin de aynƒ± yolu kullanabilir.
        
        // DINAMIK REFERANSLAR (Se√ßili men√ºye g√∂re deƒüi≈üecekler)
        let currentMenuType = 'in_place'; // Ba≈ülangƒ±√ßta Yerinde Men√º
        let productsRef;
        let campaignsRef; 
        let campaignInfoRef;
        let priceBoxUrlRef; 
        let visitorsRef = database.ref(visitorsPath); // Ziyaret√ßi referansƒ± sabit kalabilir.
        
        let products = []; 
        let campaignUrls = []; 
        let campaignPriceText = ""; 
        let campaignPriceBoxUrl = ""; 
        const categoriesTR = ['Men√ºler', 'Kokore√ß', 'Tavuk Kokore√ß', 'Tavuk D√∂ner', 'Patso', 'K√∂fte', 'Ciƒüer', 'Hamburger', 'Tost', 'Midye', 'Yan Lezzetler', 'ƒ∞√ßecekler']; 
        
        // --- HTML Element Tanƒ±mlamalarƒ± ---
        const contentContainer = document.getElementById('contentContainer');
        const showProductsBtn = document.getElementById('showProducts');
        const showSortingBtn = document.getElementById('showSorting'); 
        const showCampaignsBtn = document.getElementById('showCampaigns'); 
        const showAddProductBtn = document.getElementById('showAddProduct');
        const showBulkUpdateBtn = document.getElementById('showBulkUpdate');
        const showStatsBtn = document.getElementById('showStats');
        const tabButtons = document.querySelectorAll('.tab-button');
        const adminMenuButtons = document.querySelectorAll('.admin-menu-button');
        const editProductModal = document.getElementById('editProductModal');
        const closeEditProductModal = document.getElementById('closeEditProductModal');
        const editImageURLInput = document.getElementById('editImageURL');
        const editImagePreview = document.getElementById('editImagePreview');
        const uploadEditImageBtn = document.getElementById('uploadEditImageBtn');
        const saveEditProductButton = document.getElementById('saveEditProduct');
        
        
        // --- YENƒ∞: Dƒ∞NAMƒ∞K REFERANS Y√ñNETƒ∞Mƒ∞ ---
        function setFirebaseRefs(menuType) {
            currentMenuType = menuType;
            
            if (menuType === 'in_place') {
                productsRef = database.ref(inPlaceProductsPath);
                campaignsRef = database.ref(inPlaceCampaignsPath);
                campaignInfoRef = database.ref(inPlaceCampaignInfoPath);
            } else { // 'delivery'
                productsRef = database.ref(deliveryProductsPath);
                campaignsRef = database.ref(deliveryCampaignsPath);
                campaignInfoRef = database.ref(deliveryCampaignInfoPath);
            }
            priceBoxUrlRef = campaignInfoRef.child('price_box_url');

            // Mevcut dinleyicileri kaldƒ±rƒ±p yeni referanslara yeniden baƒülamak i√ßin
            // Burasƒ± kritik bir optimizasyon gerektirir, ancak basit√ße yeniden y√ºkleme ile halledelim.
            // Sayfayƒ± yeniden y√ºklemek yerine, dinleyicileri kaldƒ±ran ve yeni referanslara baƒülayan bir fonksiyon yazƒ±labilir.
            // ≈ûimdilik sadece referanslarƒ± ayarlayƒ±p, ardƒ±ndan dataListener'ƒ± √ßaƒüƒ±racaƒüƒ±z.
            console.log(`Firebase referanslarƒ± ayarlandƒ±: ${menuType}`);

            // UI'ƒ± g√ºncelle
            updateMenuButtonState(menuType);
            
            // T√ºm aktif dinleyicileri durdurup yeniden ba≈ülat
            stopAllListeners();
            setupDataListeners();
            
            // Mevcut aktif mod√ºl√º yeniden render et
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                activeTab.click(); // Aktif butonu tetikle (mod√ºl√º yeniden y√ºklemek i√ßin)
            } else {
                renderProductsModule();
            }
        }
        
        // UI Men√º Butonu Durumunu G√ºnceller
        function updateMenuButtonState(menuType) {
             adminMenuButtons.forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.dataset.menu === menuType) {
                     btn.classList.add('active');
                 }
             });
             // Kopyalama butonunun g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
             const copyContainer = document.getElementById('copyToDeliveryContainer');
             if (menuType === 'delivery') {
                copyContainer.classList.remove('hidden');
             } else {
                copyContainer.classList.add('hidden');
             }
        }
        
        // --- YENƒ∞: VERƒ∞ KOPYALAMA ƒ∞≈ûLEVƒ∞ ---
        async function copyMenuDataToDelivery() {
            if (currentMenuType !== 'delivery') return; // Sadece paket serviste aktif

            if (!confirm("T√ºm Yerinde Men√º (products) verileri, Paket Servis Men√ºs√ºne (delivery_products) kopyalanacak. Devam etmek istiyor musunuz? Paket Servis men√ºs√ºndeki mevcut verilerin √úZERƒ∞NE YAZILACAKTIR!")) {
                return;
            }

            const sourceProductsRef = database.ref(inPlaceProductsPath);
            const sourceCampaignsRef = database.ref(inPlaceCampaignsPath);
            const sourceCampaignInfoRef = database.ref(inPlaceCampaignInfoPath);
            
            const targetProductsRef = database.ref(deliveryProductsPath);
            const targetCampaignsRef = database.ref(deliveryCampaignsPath);
            const targetCampaignInfoRef = database.ref(deliveryCampaignInfoPath);


            try {
                // 1. √úr√ºnleri Kopyala
                let snapshot = await sourceProductsRef.once('value');
                await targetProductsRef.set(snapshot.val() || {});
                console.log("√úr√ºnler ba≈üarƒ±yla kopyalandƒ±.");

                // 2. Kampanyalarƒ± Kopyala
                snapshot = await sourceCampaignsRef.once('value');
                await targetCampaignsRef.set(snapshot.val() || {});
                console.log("Kampanyalar ba≈üarƒ±yla kopyalandƒ±.");
                
                // 3. Kampanya Bilgisini Kopyala (Fiyat Metni, Kutucuk G√∂rseli vb.)
                snapshot = await sourceCampaignInfoRef.once('value');
                await targetCampaignInfoRef.set(snapshot.val() || {});
                console.log("Kampanya bilgisi ba≈üarƒ±yla kopyalandƒ±.");

                alert("Veriler ba≈üarƒ±yla Yerinde Men√º'den Paket Servis Men√ºs√º'ne kopyalandƒ±!");
                
                // Kopyalama sonrasƒ± referanslarƒ±n tekrar tetiklenmesi i√ßin
                setFirebaseRefs('delivery'); 

            } catch (error) {
                 alert("Veri kopyalama sƒ±rasƒ±nda bir hata olu≈ütu: " + error.message);
                 console.error("Veri kopyalama hatasƒ±:", error);
            }
        }


        // --- MOD√úL VE UI Y√ñNETƒ∞Mƒ∞ ---

        function setActiveTab(buttonId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(buttonId).classList.add('active');
        }

        function loadModule(htmlContent) {
            contentContainer.innerHTML = htmlContent;
        }

        function openCloudinaryWidget(urlInput, previewImg, uploadPreset = CLOUDINARY_UPLOAD_PRESET) {
            if (!CLOUDINARY_CLOUD_NAME || !uploadPreset) {
                alert("Hata: Cloudinary ayarlarƒ± eksik.");
                return;
            }

            const widget = window.cloudinary.createUploadWidget(
                {
                    cloudName: CLOUDINARY_CLOUD_NAME,
                    uploadPreset: uploadPreset, 
                    sources: ['local', 'url', 'camera'], 
                },
                (error, result) => {
                    if (!error && result && result.event === "success") {
                        const url = result.info.secure_url;
                        urlInput.value = url; 
                        previewImg.src = url; 
                        previewImg.classList.remove('hidden'); 
                        alert("G√∂rsel y√ºklendi ve URL kaydedildi.");
                    } else if (error) {
                        console.error("Cloudinary y√ºkleme hatasƒ±:", error);
                        alert("G√∂rsel y√ºklenirken bir hata olu≈ütu: " + error.message);
                    }
                }
            );
            widget.open();
        }
        
        async function updateProductInFirebase(key, updates) {
            updates.lastUpdated = Date.now(); 
            // productsRef dinamik olduƒüu i√ßin doƒüru yola yazacak.
            await productsRef.child(key).update(updates);
        }

        async function deleteProductFromFirebase(key) {
            // productsRef dinamik olduƒüu i√ßin doƒüru yoldan silecek.
            await productsRef.child(key).remove();
        }
        
        async function deleteCampaignUrl(key) {
             // campaignsRef dinamik olduƒüu i√ßin doƒüru yoldan silecek.
             await campaignsRef.child(key).remove();
        }
        
        function sortProductsByOrder(productsArray) {
            return productsArray.sort((a, b) => (a.order === undefined ? 9999 : a.order) - (b.order === undefined ? 9999 : b.order));
        }

        // --- MOD√úL: √úR√úN Y√ñNETƒ∞Mƒ∞ (PRODUCTS) ---
        function renderProductsModule() {
            setActiveTab('showProducts');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üì¶ ${menuTitle} √úr√ºn Y√∂netimi</h2>
                <div class="flex gap-4 mb-4">
                    <select id="filterCategory" class="border p-2 rounded flex-1">
                        <option value="T√ºm√º">T√ºm√º</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <ul id="productList" class="flex flex-col gap-3">
                    <li class="p-4 bg-white rounded shadow text-gray-500">√úr√ºnler y√ºkleniyor...</li>
                </ul>
            `);
            const filterSelect = document.getElementById('filterCategory');
            filterSelect.addEventListener('change', () => renderProductList(filterSelect.value));
            if (products.length > 0) {
                 renderProductList(filterSelect.value);
            }
        }

        function renderProductList(filter='T√ºm√º') {
            const listEl = document.getElementById('productList');
            if (!listEl) return;
            listEl.innerHTML = '';
            
            const sortedProducts = sortProductsByOrder([...products]); 
            const filtered = filter === 'T√ºm√º' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                listEl.innerHTML = '<li class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride √ºr√ºn bulunmamaktadƒ±r.</li>';
                return;
            }

            filtered.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'flex justify-between items-center bg-white p-3 rounded border shadow-sm';
                item.innerHTML = `
                    <span class="font-medium text-base">${p.name} (${p.category}) - ${p.price} ‚Ç∫</span>
                    <div>
                        <button data-key="${p.key}" class="editBtn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition mr-2">D√ºzenle</button>
                        <button data-key="${p.key}" class="deleteBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">Sil</button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const productKeyToDelete = e.target.dataset.key;
                    if (confirm("Bu √ºr√ºn√º silmek istediƒüinizden emin misiniz?")) {
                        try { await deleteProductFromFirebase(productKeyToDelete); alert("√úr√ºn silindi."); } 
                        catch (error) { alert("Silme i≈ülemi ba≈üarƒ±sƒ±z oldu: " + error.message); }
                    }
                });
            });
            document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', (e) => openEditModal(e.target.dataset.key)));
        }

        // --- MOD√úL: √úR√úN SIRALAMA AYARI (SORTING) ---
        
        function renderSortingModule() {
            if (typeof Sortable === 'undefined') {
                alert("Hata: √úr√ºn sƒ±ralama √∂zelliƒüi i√ßin gerekli k√ºt√ºphane (Sortable.js) y√ºklenemedi. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.");
                return;
            }
            
            setActiveTab('showSorting');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">‚¨ÜÔ∏è ${menuTitle} √úr√ºn Sƒ±ralama Ayarƒ±</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">√úr√ºnleri s√ºr√ºkleyip bƒ±rakarak men√ºdeki sƒ±ralamasƒ±nƒ± deƒüi≈ütirebilirsiniz. Bu ayar t√ºm dillerde ge√ßerli olacaktƒ±r.</p>
                    
                    <label class="block mb-2 font-semibold text-sm">Sƒ±ralanacak Kategori Se√ßin:</label>
                    <select id="sortCategory" class="border p-2 rounded w-full mb-6">
                        <option value="">-- Kategori Se√ßiniz --</option>
                        <option value="T√ºm√º">T√ºm√º (T√ºm √úr√ºnler)</option> ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <ul id="sortableList" class="flex flex-col gap-2 p-2 border rounded bg-gray-50 min-h-[100px]">
                        <li class="text-gray-500 text-center py-4">L√ºtfen yukarƒ±dan bir kategori se√ßiniz.</li>
                    </ul>
                    
                    <button id="saveSorting" class="mt-6 bg-green-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-green-600 transition w-full hidden">Yeni Sƒ±ralamayƒ± Kaydet</button>
                    <p id="sortingStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);
            
            // Event Listeners
            const sortCategorySelect = document.getElementById('sortCategory');
            sortCategorySelect.addEventListener('change', (e) => loadSortableList(e.target.value));
            document.getElementById('saveSorting').addEventListener('click', saveSortingOrder);
        }
        
        // Kategori se√ßildiƒüinde s√ºr√ºkle-bƒ±rak listesini y√ºkler
        function loadSortableList(category) {
            const listEl = document.getElementById('sortableList');
            const saveBtn = document.getElementById('saveSorting');
            const statusEl = document.getElementById('sortingStatus');
            statusEl.classList.add('hidden');
            saveBtn.classList.add('hidden');
            listEl.innerHTML = '';
            
            if (!category || products.length === 0) {
                listEl.innerHTML = `<li class="text-gray-500 text-center py-4">${products.length === 0 ? '√úr√ºn verileri y√ºkleniyor...' : 'L√ºtfen yukarƒ±dan bir kategori se√ßiniz.'}</li>`;
                return;
            }
            
            const filteredProducts = category === 'T√ºm√º'
                ? products
                : products.filter(p => p.category === category);
            
            const filteredAndSorted = sortProductsByOrder(filteredProducts);


            if (filteredAndSorted.length === 0) {
                listEl.innerHTML = `<li class="text-gray-500 text-center py-4">"${category}" kategorisinde √ºr√ºn bulunmamaktadƒ±r.</li>`;
                return;
            }
            
            filteredAndSorted.forEach((p) => {
                const item = document.createElement('li');
                item.className = 'sortable-item flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-200';
                item.dataset.id = p.key; 
                item.innerHTML = `
                    <span class="text-gray-400 mr-3">‚ò∞</span>
                    <span class="font-medium text-base flex-1">${p.name}</span>
                    <span class="text-orange-600 font-semibold">${p.price} ‚Ç∫</span>
                `;
                listEl.appendChild(item);
            });
            
            saveBtn.classList.remove('hidden');

            Sortable.create(listEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    statusEl.textContent = 'Sƒ±ralama deƒüi≈ütirildi. Kaydet butonuna basmayƒ± unutmayƒ±n!';
                    statusEl.classList.remove('hidden');
                    statusEl.classList.remove('text-green-600');
                    statusEl.classList.add('text-red-600');
                },
            });
        }
        
        // Yeni sƒ±ralama d√ºzenini (order deƒüerlerini) Firebase'e kaydeder
        async function saveSortingOrder() {
            const listEl = document.getElementById('sortableList');
            const items = listEl.children;
            const updates = {};
            const statusEl = document.getElementById('sortingStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceProductsPath : deliveryProductsPath;
            
            if (items.length === 0) return;
            
            for (let i = 0; i < items.length; i++) {
                const productKey = items[i].dataset.id;
                const newOrderValue = i; 
                
                const currentProduct = products.find(p => p.key === productKey);
                
                if (currentProduct && currentProduct.order !== newOrderValue) {
                    // Dinamik yolu burada kullanƒ±yoruz
                    updates[`${pathPrefix}/${productKey}/order`] = newOrderValue; 
                    changesMade++;
                }
            }
            
            if (changesMade === 0) {
                 statusEl.textContent = 'Herhangi bir sƒ±ralama deƒüi≈üikliƒüi tespit edilmedi.';
                 statusEl.classList.remove('text-red-600');
                 statusEl.classList.add('text-green-600');
                 statusEl.classList.remove('hidden');
                 return;
            }
            
            if (!confirm(`${changesMade} √ºr√ºn√ºn sƒ±ralamasƒ± g√ºncellenecektir. Onaylƒ±yor musunuz?`)) {
                return;
            }

            try {
                await database.ref().update(updates); 
                
                statusEl.textContent = `${changesMade} √ºr√ºn sƒ±ralamasƒ± ba≈üarƒ±yla kaydedildi.`;
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                statusEl.classList.remove('hidden');
                
                const currentCategory = document.getElementById('sortCategory').value;
                loadSortableList(currentCategory); 

            } catch (error) {
                statusEl.textContent = 'Sƒ±ralamayƒ± kaydetme ba≈üarƒ±sƒ±z oldu: ' + error.message;
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.remove('hidden');
            }
        }

        // --- MOD√úL: KAMPANYA G√ñRSELLERƒ∞ Y√ñNETƒ∞Mƒ∞ ---

        function renderCampaignModule() {
            setActiveTab('showCampaigns');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üñºÔ∏è ${menuTitle} Kampanya G√∂rselleri Y√∂netimi</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">Bu g√∂rseller ana sayfadaki otomatik d√∂nen banner (slider) alanƒ±nda kullanƒ±lƒ±r.</p>

                    <div class="border p-4 mb-6 rounded-lg bg-red-50">
                        <h3 class="font-bold mb-3 text-red-700">üìå Kampanya Fiyat Kutucuƒüu G√∂rseli</h3>
                        <p class="text-sm text-gray-600 mb-3">Bu g√∂rsel, kampanyalarƒ±n √ºzerinde sabit duran ≈üƒ±k fiyat etiketidir. (√ñrn: Sarƒ±-Siyah Daire)</p>
                        
                        <img id="priceBoxImagePreview" class="price-box-preview-img ${campaignPriceBoxUrl ? '' : 'hidden'}" src="${campaignPriceBoxUrl}" alt="Fiyat Kutucuƒüu √ñnizleme">
                        
                        <button id="uploadPriceBoxImageBtn" class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition w-full font-semibold">Kutucuk G√∂rseli Y√ºkle / Deƒüi≈ütir</button>
                        <input type="hidden" id="priceBoxImageURL" value="${campaignPriceBoxUrl}" />
                    </div>
                    
                    <div class="border p-4 mb-6 rounded-lg bg-yellow-50">
                        <h3 class="font-bold mb-3 text-red-600">Toplu Kampanya Fiyat Metni</h3>
                        <p class="text-sm text-gray-600 mb-3">Bu metin, y√ºklediƒüiniz **kutucuk g√∂rseli i√ßinde** g√∂sterilir. (√ñrn: "250 ‚Ç∫", "%20 ƒ∞ndirim")</p>
                        <input id="campaignPriceTextInput" type="text" placeholder="√ñrn: 250 ‚Ç∫" value="${campaignPriceText}" class="border p-2 rounded w-full mb-3" />
                        <button id="saveCampaignPriceTextBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition w-full font-semibold">Fiyat Metnini Kaydet</button>
                        <p id="campaignPriceStatus" class="mt-2 text-sm text-green-600 hidden"></p>
                    </div>

                    <div class="border p-4 mb-6 rounded-lg bg-gray-50">
                        <h3 class="font-bold mb-3 text-orange-600">Yeni Banner G√∂rseli Y√ºkle</h3>
                        <p class="text-sm text-gray-600 mb-3">√ñnerilen g√∂rsel boyutu: Geni≈ü ve yatay (√ñrn: 800x300 piksel).</p>
                        <button id="uploadNewCampaignImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full">G√∂rsel Y√ºkle (Cloudinary)</button>
                        <img id="newCampaignImagePreview" class="campaign-image-preview hidden" src="" alt="Yeni Kampanya G√∂rseli √ñnizleme">
                        <input type="hidden" id="newCampaignImageURL" value="" />
                        <button id="addCampaignUrlBtn" class="mt-3 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition w-full hidden">G√∂rseli Listeye Ekle</button>
                    </div>

                    <h3 class="font-bold text-xl mb-3 text-gray-800">Mevcut Kampanya G√∂rselleri (${campaignUrls.length} Adet)</h3>
                    <p class="mb-3 text-sm text-red-600 font-semibold">G√∂rselleri s√ºr√ºkle bƒ±rak yaparak sƒ±ralayabilirsiniz.</p>
                    <ul id="sortableCampaignList" class="flex flex-col gap-2 p-2 border rounded bg-gray-50 min-h-[50px]">
                        </ul>
                    <button id="saveCampaignSorting" class="mt-4 bg-green-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-green-600 transition w-full hidden">Yeni Sƒ±ralamayƒ± Kaydet</button>
                    <p id="campaignSortingStatus" class="mt-2 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);
            
            // Event Listeners (Fiyat Kutucuƒüu)
            const priceBoxUrlInput = document.getElementById('priceBoxImageURL');
            const priceBoxPreview = document.getElementById('priceBoxImagePreview');

            document.getElementById('uploadPriceBoxImageBtn').addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(priceBoxUrlInput, priceBoxPreview);
                // Kutucuk g√∂rseli y√ºklendiƒüinde Firebase'e kaydet
                priceBoxUrlInput.addEventListener('change', async () => {
                    const newUrl = priceBoxUrlInput.value.trim();
                    if(newUrl) {
                         try {
                             // priceBoxUrlRef dinamik olduƒüu i√ßin doƒüru yola yazacak.
                             await priceBoxUrlRef.set(newUrl); 
                             campaignPriceBoxUrl = newUrl; // Global deƒüi≈ükeni g√ºncelle
                             alert("Kutucuk g√∂rseli ba≈üarƒ±yla g√ºncellendi.");
                         } catch (error) {
                             alert("Kutucuk g√∂rselini kaydetme ba≈üarƒ±sƒ±z oldu: " + error.message);
                         }
                    }
                }, { once: true });
            });


            // Event Listeners (Banner G√∂rseli Y√ºkleme ve Silme)
            const urlInput = document.getElementById('newCampaignImageURL');
            const previewImg = document.getElementById('newCampaignImagePreview');
            const addBtn = document.getElementById('addCampaignUrlBtn');
            
            document.getElementById('uploadNewCampaignImageBtn').addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(urlInput, previewImg); 
                addBtn.classList.remove('hidden');
            });

            addBtn.addEventListener('click', addCampaignUrl);
            
            // Kampanya Fiyat Metni Kaydetme Olayƒ±
            document.getElementById('saveCampaignPriceTextBtn').addEventListener('click', saveCampaignPriceText);
            
            // YENƒ∞: Kampanya Sƒ±ralama Olay Dinleyicisi
            document.getElementById('saveCampaignSorting').addEventListener('click', saveCampaignSortingOrder);
            
            renderCampaignList();
            
             // Input deƒüerlerini Firebase'den gelen veriye g√∂re ayarla
            document.getElementById('campaignPriceTextInput').value = campaignPriceText;
        }
        
        // Kampanya Fiyat Metnini Firebase'e kaydeder
        async function saveCampaignPriceText() {
            const textInput = document.getElementById('campaignPriceTextInput');
            const statusEl = document.getElementById('campaignPriceStatus');
            const newText = textInput.value.trim();

            try {
                // campaignInfoRef dinamik olduƒüu i√ßin doƒüru yola yazacak.
                await campaignInfoRef.child('price_text').set(newText);
                
                campaignPriceText = newText; 
                statusEl.textContent = 'Kampanya fiyat metni ba≈üarƒ±yla kaydedildi!';
                statusEl.classList.remove('hidden', 'text-red-600');
                statusEl.classList.add('text-green-600');
            } catch (error) {
                statusEl.textContent = 'Kaydetme ba≈üarƒ±sƒ±z oldu: ' + error.message;
                statusEl.classList.remove('hidden', 'text-green-600');
                statusEl.classList.add('text-red-600');
            }
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }
        
        // Mevcut Kampanya G√∂rsellerini Listeler ve Sƒ±ralamayƒ± Ayarlar
        function renderCampaignList() {
            const listEl = document.getElementById('sortableCampaignList');
            const saveBtn = document.getElementById('saveCampaignSorting');
            const statusEl = document.getElementById('campaignSortingStatus');
            if (!listEl) return;
            
            // 1. G√∂rselleri order deƒüerine g√∂re sƒ±rala (order olmayanlarƒ± sona at)
            const sortedCampaigns = [...campaignUrls].sort((a, b) => 
                (a.order === undefined ? 9999 : a.order) - (b.order === undefined ? 9999 : b.order)
            );
            
            listEl.innerHTML = '';
            saveBtn.classList.add('hidden');
            statusEl.classList.add('hidden');

            if (sortedCampaigns.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500 text-center py-4">Hen√ºz kampanya g√∂rseli eklenmedi.</li>';
                return;
            }
            
            saveBtn.classList.remove('hidden');

            sortedCampaigns.forEach((c) => {
                const item = document.createElement('li');
                item.className = 'sortable-item flex items-center bg-white p-3 rounded shadow-sm border border-gray-200';
                item.dataset.id = c.key; // Sortable.js i√ßin key
                item.innerHTML = `
                    <span class="text-gray-400 mr-3">‚ò∞</span>
                    <img src="${c.url}" class="campaign-item-img" alt="Kampanya G√∂rseli">
                    <span class="text-sm flex-1 truncate">${c.url}</span>
                    <button data-key="${c.key}" class="deleteCampaignBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition ml-3">Sil</button>
                `;
                listEl.appendChild(item);
            });

            // 2. Sortable.js'i Listeye Uygula
            Sortable.create(listEl, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    statusEl.textContent = 'Sƒ±ralama deƒüi≈ütirildi. Kaydet butonuna basmayƒ± unutmayƒ±n!';
                    statusEl.classList.remove('hidden', 'text-green-600');
                    statusEl.classList.add('text-red-600');
                },
            });

            // 3. Silme Butonu Event Listener'larƒ±nƒ± tekrar baƒüla
            document.querySelectorAll('.deleteCampaignBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const keyToDelete = e.target.dataset.key;
                    if (confirm("Bu kampanya g√∂rselini silmek istediƒüinizden emin misiniz?")) {
                        try { 
                            await deleteCampaignUrl(keyToDelete); 
                            alert("Kampanya g√∂rseli silindi."); 
                        } catch (error) { 
                            alert("Silme i≈ülemi ba≈üarƒ±sƒ±z oldu: " + error.message); 
                        }
                    }
                });
            });
        }
        
        // Yeni g√∂rsel URL'sini Firebase'e kaydeder
        async function addCampaignUrl() {
            const url = document.getElementById('newCampaignImageURL').value.trim();
            if (!url) {
                alert('L√ºtfen √∂nce bir g√∂rsel y√ºkleyin.');
                return;
            }
            
            // Yeni eklenen kampanyanƒ±n order deƒüerini, mevcutlarƒ±n en sonuna ayarla
            const maxOrder = campaignUrls.length > 0 
                ? Math.max(...campaignUrls.map(c => c.order === undefined ? 0 : c.order))
                : 0;

            try {
                // campaignsRef dinamik olduƒüu i√ßin doƒüru yola yazacak.
                await campaignsRef.push({ 
                    url: url, 
                    timestamp: Date.now(),
                    order: maxOrder + 1 
                }); 
                alert("Kampanya g√∂rseli ba≈üarƒ±yla listeye eklendi.");
                
                document.getElementById('newCampaignImageURL').value = '';
                document.getElementById('newCampaignImagePreview').src = '';
                document.getElementById('newCampaignImagePreview').classList.add('hidden');
                document.getElementById('addCampaignUrlBtn').classList.add('hidden');
                
            } catch (error) {
                alert("G√∂rsel ekleme ba≈üarƒ±sƒ±z oldu: " + error.message);
            }
        }
        
        // Kampanyalarƒ±n Yeni Sƒ±ralama D√ºzenini Kaydeder
        async function saveCampaignSortingOrder() {
            const listEl = document.getElementById('sortableCampaignList');
            const items = listEl.children;
            const updates = {};
            const statusEl = document.getElementById('campaignSortingStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceCampaignsPath : deliveryCampaignsPath;

            if (items.length === 0) return;
            
            for (let i = 0; i < items.length; i++) {
                const campaignKey = items[i].dataset.id;
                const newOrderValue = i; 
                
                const currentCampaign = campaignUrls.find(c => c.key === campaignKey);
                
                if (currentCampaign && currentCampaign.order !== newOrderValue) {
                    // Dinamik yolu burada kullanƒ±yoruz
                    updates[`${pathPrefix}/${campaignKey}/order`] = newOrderValue; 
                    changesMade++;
                }
            }
            
            if (changesMade === 0) {
                 statusEl.textContent = 'Herhangi bir sƒ±ralama deƒüi≈üikliƒüi tespit edilmedi.';
                 statusEl.classList.remove('text-red-600');
                 statusEl.classList.add('text-green-600');
                 statusEl.classList.remove('hidden');
                 return;
            }
            
            if (!confirm(`${changesMade} kampanya g√∂rselinin sƒ±ralamasƒ± g√ºncellenecektir. Onaylƒ±yor musunuz?`)) {
                return;
            }

            try {
                // T√ºm g√ºncellemeleri tek seferde Firebase'e g√∂nder
                await database.ref().update(updates); 
                
                statusEl.textContent = `${changesMade} kampanya sƒ±ralamasƒ± ba≈üarƒ±yla kaydedildi.`;
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                statusEl.classList.remove('hidden');

            } catch (error) {
                statusEl.textContent = 'Sƒ±ralamayƒ± kaydetme ba≈üarƒ±sƒ±z oldu: ' + error.message;
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.remove('hidden');
            }
        }


        // --- MOD√úL: YENƒ∞ √úR√úN EKLEME (ADD PRODUCT) ---
        function renderAddProductModule() {
            setActiveTab('showAddProduct');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">‚ûï ${menuTitle} Yeni √úr√ºn Ekle</h2>
                <div class="flex flex-col gap-4 p-6 border rounded-lg bg-white shadow-md max-w-lg">
                    <input id="productName" placeholder="√úr√ºn Adƒ± (TR)" class="border p-3 rounded" />
                    <input id="productNameEN" placeholder="Product Name (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productDesc" placeholder="A√ßƒ±klama (TR)" class="border p-3 rounded" />
                    <input id="productDescEN" placeholder="Description (EN) (Opsiyonel)" class="border p-3 rounded" />
                    <input id="productPrice" type="number" placeholder="Fiyat (‚Ç∫)" class="border p-3 rounded" />
                    <select id="productCategory" class="border p-3 rounded">
                        <option value="">-- Kategori Se√ßiniz --</option>
                        ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold mb-2">G√∂rsel Y√ºkle (Opsiyonel)</h3>
                        <button id="uploadNewImageBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full">G√∂rsel Y√ºkle</button>
                        <img id="newImagePreview" class="w-full h-32 object-cover rounded-lg mt-3 border border-gray-300" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>G√∂rsel Yok</text></svg>" alt="Yeni G√∂rsel √ñnizleme">
                        <input type="hidden" id="productImageURL" value="" />
                    </div>
                    
                    <button id="addProduct" class="bg-orange-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-orange-600 transition">√úr√ºn√º Kaydet</button>
                </div>
            `);
            // Event Listener'lar
            document.getElementById('uploadNewImageBtn').addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(document.getElementById('productImageURL'), document.getElementById('newImagePreview'));
            });
            document.getElementById('addProduct').addEventListener('click', addProduct);

            document.getElementById('newImagePreview').src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>G√∂rsel Yok</text></svg>";
        }

        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const nameEN = document.getElementById('productNameEN').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const descEN = document.getElementById('productDescEN').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            
            let imageURL = document.getElementById('productImageURL').value.trim(); 
            
            if (!imageURL) { imageURL = ''; }

            if (!name || isNaN(price) || !category) { 
                alert('L√ºtfen t√ºm zorunlu alanlarƒ± (Ad, Fiyat ve Kategori) doldurunuz.'); return; 
            }
            
            const maxOrder = products.length > 0 
                ? Math.max(...products.map(p => p.order === undefined ? 0 : p.order))
                : 0;
            
            const newProduct = {
                name, nameEN: nameEN || name, desc, descEN: descEN || desc,
                price, image: imageURL, category, 
                lastUpdated: Date.now(),
                order: maxOrder + 1 
            };

            try {
                // productsRef dinamik olduƒüu i√ßin doƒüru yola yazacak.
                await productsRef.push(newProduct); 
                alert(`"${name}" √ºr√ºn√º ba≈üarƒ±yla eklendi.`);
                
                document.querySelectorAll('#contentContainer input, #contentContainer select').forEach(el => el.value = '');
                document.getElementById('productImageURL').value = ''; 
                
                const previewImg = document.getElementById('newImagePreview');
                previewImg.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='10' fill='%236b7280'>G√∂rsel Yok</text></svg>";
                
            } catch (error) {
                alert("Ekleme i≈ülemi ba≈üarƒ±sƒ±z oldu: " + error.message);
            }
        }

        // --- MOD√úL: TOPLU Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞RME (BULK UPDATE) ---
        function renderBulkUpdateModule() {
            setActiveTab('showBulkUpdate');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üí∏ ${menuTitle} Toplu Fiyat Deƒüi≈ütirme</h2>
                <div class="p-6 bg-white rounded-lg shadow-md max-w-2xl">
                    <p class="mb-4 text-gray-600">A≈üaƒüƒ±daki listede √ºr√ºnlerin mevcut fiyatlarƒ±nƒ± deƒüi≈ütirebilir veya Toplu Deƒüi≈üim ara√ßlarƒ±nƒ± kullanabilirsiniz. **Yeni fiyatlarƒ± manuel olarak sƒ±ra sƒ±ra da girebilirsiniz.**</p>
                    
                    <div class="border p-4 mb-6 rounded-lg bg-gray-50">
                        <h3 class="font-bold mb-3 text-orange-600">Toplu Deƒüi≈üim Ara√ßlarƒ±</h3>
                        <label class="block mb-2 font-semibold text-sm">Uygulanacak Kategori:</label>
                        <select id="bulkCategory" class="border p-2 rounded w-full mb-3">
                            <option value="T√ºm√º">T√ºm √úr√ºnler</option>
                            ${categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>

                        <label class="block mb-2 font-semibold text-sm">Deƒüi≈üim Tipi:</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center"><input type="radio" name="updateType" value="percent" checked class="mr-2"> Y√ºzdesel (%)</label>
                            <label class="flex items-center"><input type="radio" name="updateType" value="fixed" class="mr-2"> Sabit Deƒüer (‚Ç∫)</label>
                        </div>

                        <input id="updateValue" type="number" placeholder="√ñrn: 10 (‚Ç∫10 artƒ±≈ü) veya -5 (%5 indirim)" class="border p-2 rounded w-full mb-4" />
                        
                        <button id="applyBulkAdjustment" class="bg-blue-500 text-white px-4 py-2 rounded font-semibold hover:bg-blue-600 transition w-full">Se√ßili √úr√ºnlere Toplu Ayar Uygula</button>
                    </div>

                    <h3 class="font-bold text-xl mb-3 text-gray-800">√úr√ºn Fiyatlarƒ±nƒ± Manuel D√ºzenle</h3>
                    <div class="flex font-bold text-sm bg-gray-100 p-2 rounded mb-2">
                        <span class="w-1/2">√úr√ºn Adƒ±</span>
                        <span class="w-1/4 text-right">Mevcut Fiyat</span>
                        <span class="w-1/4 text-right">Yeni Fiyat (‚Ç∫)</span>
                    </div>
                    <form id="bulkUpdateForm" class="flex flex-col gap-2">
                        <p class="text-gray-500">√úr√ºnler y√ºkleniyor...</p>
                        </form>
                    
                    <button id="saveManualPrices" class="mt-6 bg-red-500 text-white px-4 py-3 rounded text-lg font-semibold hover:bg-red-600 transition w-full">Girdiƒüim Yeni Fiyatlarƒ± Kaydet</button>
                    <p id="bulkStatus" class="mt-4 text-center text-sm text-green-600 hidden"></p>
                </div>
            `);

            // Event Listener'lar
            document.getElementById('bulkCategory').addEventListener('change', () => renderBulkPriceList(document.getElementById('bulkCategory').value));
            document.getElementById('applyBulkAdjustment').addEventListener('click', applyBulkAdjustment);
            document.getElementById('saveManualPrices').addEventListener('click', saveManualPrices);
            
            renderBulkPriceList(document.getElementById('bulkCategory').value);
        }
        
        // Toplu fiyat listesini d√ºzenlenebilir inputlarla render eder
        function renderBulkPriceList(filter='T√ºm√º') {
            const formEl = document.getElementById('bulkUpdateForm');
            if (!formEl) return;
            formEl.innerHTML = '';
            
            const sortedProducts = sortProductsByOrder([...products]);

            const filtered = filter === 'T√ºm√º' ? sortedProducts : sortedProducts.filter(p => p.category === filter);

            if (filtered.length === 0) {
                formEl.innerHTML = '<p class="p-4 bg-white rounded shadow text-gray-500">Bu kategoride √ºr√ºn bulunmamaktadƒ±r.</p>';
                return;
            }

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-white p-2 rounded border text-sm';
                item.innerHTML = `
                    <span class="w-1/2">${p.name}</span>
                    <span class="w-1/4 text-right font-medium">${p.price} ‚Ç∫</span>
                    <input 
                        type="number" 
                        step="1" 
                        placeholder="${p.price}" 
                        value="${p.price}"
                        data-key="${p.key}" 
                        class="bulk-price-input w-1/4 text-right border p-1 rounded focus:border-orange-500"
                    />
                `;
                formEl.appendChild(item);
            });
        }

        // Toplu y√ºzdesel/sabit ayarƒ± input alanlarƒ±na uygular
        function applyBulkAdjustment() {
            const updateType = document.querySelector('input[name="updateType"]:checked').value;
            const value = parseFloat(document.getElementById('updateValue').value);
            const statusEl = document.getElementById('bulkStatus');
            statusEl.classList.add('hidden');

            if (isNaN(value) || value === 0) {
                statusEl.textContent = 'L√ºtfen ge√ßerli bir deƒüi≈üim deƒüeri girin.';
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            let updatedCount = 0;

            inputs.forEach(input => {
                const productKey = input.dataset.key;
                const currentProduct = products.find(p => p.key === productKey);
                if (!currentProduct) return;

                let newPrice;
                const basePrice = currentProduct.price; 

                if (updateType === 'percent') {
                    newPrice = basePrice * (1 + (value / 100));
                } else { // fixed
                    newPrice = basePrice + value;
                }
                newPrice = Math.max(0, newPrice); // Max 0'dan b√ºy√ºk olmalƒ±
                
                input.value = parseFloat(newPrice.toFixed(2)); // ƒ∞ki ondalƒ±k basamaƒüa yuvarla
                updatedCount++;
            });

            if (updatedCount > 0) {
                statusEl.textContent = `${updatedCount} √ºr√ºn√ºn fiyatƒ± g√ºncellendi. L√ºtfen "Kaydet" butonuna basarak deƒüi≈üiklikleri veritabanƒ±na i≈üleyin.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
            } else {
                 statusEl.textContent = 'G√ºncellenecek √ºr√ºn bulunamadƒ±.';
                 statusEl.classList.remove('hidden');
                 statusEl.classList.remove('text-green-600');
                 statusEl.classList.add('text-red-600');
            }
        }


        // Manuel girilen fiyatlarƒ± Firebase'e kaydeder
        async function saveManualPrices() {
            const inputs = document.querySelectorAll('#bulkUpdateForm .bulk-price-input');
            const updates = {};
            const currentTime = Date.now();
            const statusEl = document.getElementById('bulkStatus');
            let changesMade = 0;
            const pathPrefix = currentMenuType === 'in_place' ? inPlaceProductsPath : deliveryProductsPath;
            let invalidPrices = []; // Ge√ßersiz fiyatlarƒ± tutacak dizi


            if (inputs.length === 0) {
                statusEl.textContent = 'Kaydedilecek √ºr√ºn bulunamadƒ±.';
                statusEl.classList.remove('hidden', 'text-green-600');
                statusEl.classList.add('text-red-600');
                return;
            }

            for (const input of inputs) {
                const productKey = input.dataset.key;
                const newPrice = parseFloat(input.value);
                const currentProduct = products.find(p => p.key === productKey);

                if (isNaN(newPrice) || newPrice < 0) {
                    invalidPrices.push(currentProduct.name);
                    continue; // Ge√ßersiz fiyatƒ± atla, diƒüerlerini kaydetmeye devam et
                }
                
                const currentPriceRounded = parseFloat(currentProduct.price.toFixed(2));
                const newPriceRounded = parseFloat(newPrice.toFixed(2));


                if (currentProduct && currentPriceRounded !== newPriceRounded) {
                    // Dinamik yolu burada kullanƒ±yoruz
                    updates[`${pathPrefix}/${productKey}/price`] = newPriceRounded;
                    updates[`${pathPrefix}/${productKey}/lastUpdated`] = currentTime; 
                    changesMade++;
                }
            }
            
            // Hata Kontrol√º
            if (invalidPrices.length > 0) {
                alert(`A≈üaƒüƒ±daki √ºr√ºnler i√ßin ge√ßersiz fiyat girdiniz ve kaydedilemediler: \n- ${invalidPrices.join('\n- ')}\n\nDiƒüer ge√ßerli fiyatlar kaydedilmeye devam ediliyor.`);
            }


            if (changesMade === 0) {
                statusEl.textContent = 'Herhangi bir fiyat deƒüi≈üikliƒüi tespit edilmedi.';
                statusEl.classList.remove('hidden', 'text-red-600');
                statusEl.classList.add('text-green-600');
                return;
            }
            
            if (!confirm(`${changesMade} √ºr√ºn√ºn fiyatƒ± g√ºncellenecektir. Onaylƒ±yor musunuz?`)) {
                return;
            }

            try {
                await database.ref().update(updates); 
                statusEl.textContent = `${changesMade} √ºr√ºn fiyatƒ± ba≈üarƒ±yla kaydedildi ve men√º g√ºncellendi.`;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
                // Fiyatlar g√ºncellendiƒüi i√ßin listeyi yeniden render et
                renderBulkPriceList(document.getElementById('bulkCategory').value);
            } catch (error) {
                statusEl.textContent = 'Fiyatlarƒ± kaydetme ba≈üarƒ±sƒ±z oldu: ' + error.message;
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
            }
        }
        
        // --- MOD√úL: ƒ∞STATƒ∞STƒ∞KLER (STATS) ---
        function renderStatsModule() {
            setActiveTab('showStats');
            const menuTitle = currentMenuType === 'in_place' ? 'Yerinde Men√º' : 'Paket Servis Men√ºs√º';
            
            // NOTE: Ziyaret√ßi takibi tek bir 'visitors' yolunda tutuluyor.
            // Bu y√ºzden men√ºye √∂zel bir ziyaret√ßi sayacƒ± ≈üimdilik yok.
            
            loadModule(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üìä Men√º G√∂r√ºnt√ºleme ƒ∞statistikleri</h2>
                <div class="grid grid-cols-2 gap-6 max-w-xl">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">Bug√ºnk√º G√∂r√ºnt√ºleme</h3>
                        <p id="todayCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-2 text-orange-600">Toplam G√∂r√ºnt√ºleme</h3>
                        <p id="totalCount" class="text-4xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="resetCounter" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Saya√ßlarƒ± Sƒ±fƒ±rla (T√ºm Zamanlar)</button>
                    <p class="text-sm text-gray-500 mt-2">NOT: Bu saya√ßlar, ${currentMenuType === 'in_place' ? 'index.html' : 'delivery.html'} dosyasƒ±nƒ±n ka√ß kez a√ßƒ±ldƒ±ƒüƒ±nƒ± g√∂sterir. Sƒ±fƒ±rlama t√ºm ge√ßmi≈üi siler.</p>
                </div>
            `);
            fetchVisitorCounts();
            document.getElementById('resetCounter').addEventListener('click', resetVisitorCounts);
        }

        function fetchVisitorCounts() {
            const today = new Date().toISOString().slice(0, 10);
            
            // Ziyaret√ßi referansƒ± sabit olduƒüu i√ßin burada dinamik bir deƒüi≈üiklik yapmaya gerek yok.
            // Ancak, ger√ßek bir ayrƒ±m i√ßin 'visitors/in_place' ve 'visitors/delivery' gibi yollar kullanƒ±lmalƒ±dƒ±r.
            visitorsRef.child(today).once('value', snapshot => {
                document.getElementById('todayCount').textContent = snapshot.val() || 0;
            });

            visitorsRef.once('value', snapshot => {
                let total = 0;
                snapshot.forEach(child => {
                    total += child.val();
                });
                document.getElementById('totalCount').textContent = total;
            });
        }
        
        async function resetVisitorCounts() {
            if (confirm("T√ºm ziyaret√ßi verilerini sƒ±fƒ±rlamak istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.")) {
                try {
                    await visitorsRef.remove();
                    alert("Ziyaret√ßi saya√ßlarƒ± ba≈üarƒ±yla sƒ±fƒ±rlandƒ±.");
                    fetchVisitorCounts(); 
                } catch (error) {
                    alert("Saya√ß sƒ±fƒ±rlama ba≈üarƒ±sƒ±z oldu: " + error.message);
                }
            }
        }

        // --- EDƒ∞T MODAL ORTAK KULLANIM FONKSƒ∞YONLARI ---
        function openEditModal(productKey) {
            const productToEdit = products.find(p => p.key === productKey);
            
            if (productToEdit) {
                document.getElementById('editProductKey').value = productKey; 
                document.getElementById('editName').value = productToEdit.name;
                document.getElementById('editNameEN').value = productToEdit.nameEN || '';
                document.getElementById('editDesc').value = productToEdit.desc || '';
                document.getElementById('editDescEN').value = productToEdit.descEN || '';
                document.getElementById('editPrice').value = productToEdit.price;
                
                const editCategorySelect = document.getElementById('editCategory');
                editCategorySelect.innerHTML = categoriesTR.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                editCategorySelect.value = productToEdit.category;
                
                editImageURLInput.value = productToEdit.image;
                editImagePreview.src = productToEdit.image;
                
                editProductModal.classList.remove('hidden');
            }
        }
        
        // --- FIREBASE DINLEYICILERI Y√ñNETƒ∞Mƒ∞ ---
        
        // Dinleyicileri tutmak i√ßin bo≈ü bir nesne
        let activeListeners = {}; 
        
        function stopAllListeners() {
            // √ñnceki dinleyicileri kapat (off metodu ile)
            if (activeListeners.products) productsRef.off('value', activeListeners.products);
            if (activeListeners.campaigns) campaignsRef.off('value', activeListeners.campaigns);
            if (activeListeners.campaignPriceText) campaignInfoRef.child('price_text').off('value', activeListeners.campaignPriceText);
            if (activeListeners.priceBoxUrl) priceBoxUrlRef.off('value', activeListeners.priceBoxUrl);
            
            activeListeners = {}; // Nesneyi temizle
        }
        
        function setupDataListeners() {
             // Firebase Dinleyicisi (√úr√ºnler)
            activeListeners.products = productsRef.on('value', (snapshot) => {
                products = [];
                snapshot.forEach(childSnapshot => {
                    const product = childSnapshot.val();
                    product.key = childSnapshot.key;
                    products.push(product);
                });
                
                const activeTab = document.querySelector('.tab-button.active');
                if (activeTab) {
                    const activeId = activeTab.id;
                    
                    if (activeId === 'showProducts') {
                        const filterSelect = document.getElementById('filterCategory');
                        if (filterSelect) renderProductList(filterSelect.value);
                    } else if (activeId === 'showBulkUpdate') {
                        const bulkSelect = document.getElementById('bulkCategory');
                        if (bulkSelect) renderBulkPriceList(bulkSelect.value);
                    } else if (activeId === 'showSorting') {
                        const sortSelect = document.getElementById('sortCategory');
                        if (sortSelect && sortSelect.value) loadSortableList(sortSelect.value);
                    }
                }
            });

            // Firebase Dinleyicisi (Kampanya G√∂rselleri)
            activeListeners.campaigns = campaignsRef.on('value', (snapshot) => {
                 campaignUrls = [];
                 snapshot.forEach(childSnapshot => {
                     const campaign = childSnapshot.val();
                     campaign.key = childSnapshot.key;
                     campaignUrls.push(campaign);
                 });
                 if (document.getElementById('sortableCampaignList')) { 
                     renderCampaignList();
                 }
            });
            
            // Firebase Dinleyicisi (Kampanya Fiyat Metni)
            activeListeners.campaignPriceText = campaignInfoRef.child('price_text').on('value', (snapshot) => {
                 campaignPriceText = snapshot.val() || "";
                 const inputEl = document.getElementById('campaignPriceTextInput');
                 if(inputEl) {
                     inputEl.value = campaignPriceText;
                 }
            });
            
            // Firebase Dinleyicisi (Fiyat Kutucuƒüu G√∂rseli URL'si)
            activeListeners.priceBoxUrl = priceBoxUrlRef.on('value', (snapshot) => {
                 campaignPriceBoxUrl = snapshot.val() || "";
                 const inputEl = document.getElementById('priceBoxImageURL');
                 const previewEl = document.getElementById('priceBoxImagePreview');
                 if(inputEl) {
                     inputEl.value = campaignPriceBoxUrl;
                 }
                 if(previewEl) {
                     previewEl.src = campaignPriceBoxUrl;
                     if(campaignPriceBoxUrl) {
                        previewEl.classList.remove('hidden');
                     } else {
                        previewEl.classList.add('hidden');
                     }
                 }
            });
        }


        // --- GENEL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // Ba≈ülangƒ±√ßta Yerinde Men√º referanslarƒ±nƒ± ayarla ve dinleyicileri ba≈ülat.
            setFirebaseRefs('in_place'); 
            
            // Navigasyon Butonlarƒ±
            showProductsBtn.addEventListener('click', renderProductsModule);
            showSortingBtn.addEventListener('click', renderSortingModule); 
            showCampaignsBtn.addEventListener('click', renderCampaignModule); 
            showAddProductBtn.addEventListener('click', renderAddProductModule);
            showBulkUpdateBtn.addEventListener('click', renderBulkUpdateModule);
            showStatsBtn.addEventListener('click', renderStatsModule);
            
            // YENƒ∞: Men√º Tipi Ge√ßi≈ü Butonlarƒ±
            document.getElementById('switchToInPlace').addEventListener('click', () => setFirebaseRefs('in_place'));
            document.getElementById('switchToDelivery').addEventListener('click', () => setFirebaseRefs('delivery'));
            
            // YENƒ∞: Veri Kopyalama Butonu
            document.getElementById('copyToDeliveryBtn').addEventListener('click', copyMenuDataToDelivery);
            
            // Edit Modal Butonlarƒ±
            closeEditProductModal.addEventListener('click', () => editProductModal.classList.add('hidden'));
            uploadEditImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openCloudinaryWidget(editImageURLInput, editImagePreview);
            });
            saveEditProductButton.addEventListener('click', async () => {
                const productKey = document.getElementById('editProductKey').value;
                const updates = {
                    name: document.getElementById('editName').value.trim(),
                    nameEN: document.getElementById('editNameEN').value.trim(),
                    desc: document.getElementById('editDesc').value.trim(),
                    descEN: document.getElementById('editDescEN').value.trim(),
                    price: parseFloat(document.getElementById('editPrice').value),
                    category: document.getElementById('editCategory').value,
                    image: editImageURLInput.value.trim()
                };
                
                if (isNaN(updates.price)) { alert('L√ºtfen ge√ßerli bir fiyat giriniz.'); return; }

                try {
                    if (!updates.image) updates.image = ''; 

                    // updateProductInFirebase fonksiyonu dinamik referansƒ± kullanacak
                    await updateProductInFirebase(productKey, updates); 
                    editProductModal.classList.add('hidden');
                    alert(`"${updates.name}" √ºr√ºn√º ba≈üarƒ±yla g√ºncellendi.`);
                } catch (error) {
                    alert("G√ºncelleme i≈ülemi ba≈üarƒ±sƒ±z oldu: " + error.message);
                }
            });
        });
    </script>
</body>
</html>
